// Enhanced lib/screens/customer/send_request_screen.dart
// Updated with improved search modal showing suggestions
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:geolocator/geolocator.dart';
import 'package:image_picker/image_picker.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:io';
import 'dart:convert';
import 'package:http_parser/http_parser.dart';

class SendRequestScreen extends StatefulWidget {
  const SendRequestScreen({super.key});

  @override
  State<SendRequestScreen> createState() => _SendRequestScreenState();
}

class _SendRequestScreenState extends State<SendRequestScreen> {
  final _formKey = GlobalKey<FormState>();
  String? _parcelSize;
  String? _paymentMethod;
  final TextEditingController _suggestedFareController =
      TextEditingController();

  // Map variables
  GoogleMapController? _mapController;
  LatLng? _pickupPosition;
  LatLng? _dropoffPosition;
  File? _parcelPhoto;

  // Default Harare position
  static const LatLng _harare = LatLng(-17.8249, 31.0469);

  bool _isLoading = false;
  bool _isSettingPickup = true;

  @override
  void initState() {
    super.initState();
    _getCurrentLocationForPickup();
  }

  Future<void> _getCurrentLocationForPickup() async {
    bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
    if (!serviceEnabled) {
      _showError('Location services are disabled. Please enable them.');
      return;
    }

    LocationPermission permission = await Geolocator.checkPermission();
    if (permission == LocationPermission.denied) {
      permission = await Geolocator.requestPermission();
      if (permission == LocationPermission.denied) {
        _showError('Location permissions are denied.');
        return;
      }
    }

    if (permission == LocationPermission.deniedForever) {
      _showError('Location permissions are permanently denied.');
      return;
    }

    try {
      Position position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.high,
      );
      setState(() {
        _pickupPosition = LatLng(position.latitude, position.longitude);
      });
      if (_mapController != null) {
        _mapController!.animateCamera(
          CameraUpdate.newLatLngZoom(_pickupPosition!, 15),
        );
      }
    } catch (e) {
      _showError('Failed to get current location: $e');
    }
  }

  // IMPROVED SEARCH FUNCTION WITH SUGGESTIONS
  Future<void> _searchAddressWithSuggestions({required bool isPickup}) async {
    final searchQuery = await showDialog<String>(
      context: context,
      builder: (context) => AddressSearchDialog(
        isPickup: isPickup,
        onSearch: (query) async {
          return await _fetchAddressSuggestions(query);
        },
      ),
    );

    if (searchQuery == null || searchQuery.isEmpty) return;

    // Show loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const AlertDialog(
        backgroundColor: Colors.white,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.all(Radius.circular(16)),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF667eea)),
            ),
            SizedBox(height: 16),
            Text(
              'Finding location...',
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w500,
                color: Color(0xFF333333),
              ),
            ),
          ],
        ),
      ),
    );

    try {
      debugPrint('Searching for: $searchQuery');

      // Use OpenStreetMap Nominatim API
      final encodedQuery = Uri.encodeComponent('$searchQuery, Zimbabwe');
      final url = Uri.parse(
        'https://nominatim.openstreetmap.org/search?q=$encodedQuery&format=json&limit=1&addressdetails=1',
      );

      // Add user-agent header
      final headers = {
        'User-Agent': 'RiderHubApp/1.0',
        'Accept': 'application/json',
      };

      final response = await http.get(url, headers: headers);
      Navigator.pop(context); // Close loading dialog

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body) as List;

        if (data.isNotEmpty) {
          final result = data[0];
          final lat = double.parse(result['lat'] as String);
          final lng = double.parse(result['lon'] as String);
          final address = result['display_name'] as String;

          // Update state
          setState(() {
            if (isPickup) {
              _pickupPosition = LatLng(lat, lng);
            } else {
              _dropoffPosition = LatLng(lat, lng);
            }
          });

          // Move camera
          if (_mapController != null) {
            _mapController!.animateCamera(
              CameraUpdate.newLatLngZoom(LatLng(lat, lng), 15),
            );
          }

          // Show success
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  Icon(Icons.check_circle, color: Colors.white, size: 20),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      '${isPickup ? 'Pickup' : 'Dropoff'} location set',
                      style: TextStyle(fontSize: 14),
                    ),
                  ),
                ],
              ),
              backgroundColor: Colors.green,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          );
        } else {
          _showError(
            'No results found for "$searchQuery".\nTry: "Harare CBD", "Avondale", "Mbare"',
          );
        }
      } else {
        _showError('Search failed. Please check your connection.');
      }
    } catch (e) {
      Navigator.pop(context); // Close loading dialog
      debugPrint('Search error: $e');
      _showError('Error searching. Please try again.');
    }
  }

  // Fetch address suggestions
  Future<List<Map<String, dynamic>>> _fetchAddressSuggestions(
    String query,
  ) async {
    if (query.length < 2) return [];

    try {
      final encodedQuery = Uri.encodeComponent('$query, Zimbabwe');
      final url = Uri.parse(
        'https://nominatim.openstreetmap.org/search?q=$encodedQuery&format=json&limit=5&addressdetails=1',
      );

      final headers = {
        'User-Agent': 'RiderHubApp/1.0',
        'Accept': 'application/json',
      };

      final response = await http.get(url, headers: headers);

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body) as List;
        return data.map((item) {
          return {
            'name': item['display_name'] as String,
            'lat': double.parse(item['lat'] as String),
            'lng': double.parse(item['lon'] as String),
            'type': _getLocationType(item),
          };
        }).toList();
      }
    } catch (e) {
      debugPrint('Suggestions error: $e');
    }
    return [];
  }

  String _getLocationType(Map<String, dynamic> data) {
    if (data['type'] == 'city' || data['type'] == 'town') {
      return 'City';
    } else if (data['type'] == 'suburb' || data['type'] == 'neighbourhood') {
      return 'Area';
    } else if (data['type'] == 'road' || data['type'] == 'street') {
      return 'Street';
    } else if (data['type'] == 'administrative') {
      return 'District';
    }
    return 'Location';
  }

  Future<void> _pickPhoto() async {
    final ImagePicker picker = ImagePicker();
    final XFile? image = await picker.pickImage(source: ImageSource.gallery);
    if (image != null) {
      setState(() {
        _parcelPhoto = File(image.path);
      });
    }
  }

  Future<void> _submitRequest() async {
    debugPrint('=== SUBMIT REQUEST STARTED (MULTIPART VERSION WITH PHOTO) ===');

    if (_formKey.currentState!.validate() &&
        _pickupPosition != null &&
        _dropoffPosition != null &&
        _parcelSize != null &&
        _paymentMethod != null) {
      debugPrint('‚úÖ All validations passed');

      setState(() {
        _isLoading = true;
      });

      try {
        final sessionId = await _getSessionId();
        if (sessionId == null) {
          debugPrint('‚ùå No session found');
          _showError('No session found. Please log in again.');
          setState(() {
            _isLoading = false;
          });
          return;
        }

        debugPrint('‚úÖ Session ID: $sessionId');

        // Create multipart request
        var request = http.MultipartRequest(
          'POST',
          Uri.parse('https://chareta.com/riderhub/api/api.php?action=requests'),
        );

        // Add headers
        request.headers['X-Session-Id'] = sessionId;

        // Add form fields
        request.fields['pickup_lat'] = _pickupPosition!.latitude.toString();
        request.fields['pickup_lng'] = _pickupPosition!.longitude.toString();
        request.fields['dropoff_lat'] = _dropoffPosition!.latitude.toString();
        request.fields['dropoff_lng'] = _dropoffPosition!.longitude.toString();
        request.fields['parcel_size'] = _parcelSize!.toLowerCase();
        request.fields['suggested_fare'] = _suggestedFareController.text.isEmpty
            ? '0'
            : _suggestedFareController.text;
        request.fields['payment_method'] = _paymentMethod!.toLowerCase();

        // Add parcel photo if available
        if (_parcelPhoto != null) {
          debugPrint('üì∏ Adding parcel photo from: ${_parcelPhoto!.path}');

          try {
            // Check file size
            final length = await _parcelPhoto!.length();
            final sizeInMB = length / (1024 * 1024);
            debugPrint('üìä Photo size: ${sizeInMB.toStringAsFixed(2)} MB');

            if (sizeInMB > 2) {
              debugPrint(
                '‚ö†Ô∏è WARNING: File is ${sizeInMB.toStringAsFixed(2)} MB',
              );
              // You might want to compress it here
            }

            // Get file extension
            String extension = _parcelPhoto!.path.split('.').last.toLowerCase();

            // Determine content type
            String contentType;
            if (extension == 'png') {
              contentType = 'image/png';
            } else if (extension == 'gif') {
              contentType = 'image/gif';
            } else {
              contentType = 'image/jpeg';
            }

            request.files.add(
              await http.MultipartFile.fromPath(
                'parcel_photo',
                _parcelPhoto!.path,
                filename:
                    'parcel_${DateTime.now().millisecondsSinceEpoch}.$extension',
                contentType: MediaType.parse(contentType),
              ),
            );
            debugPrint('‚úÖ Photo added to request (type: $contentType)');
          } catch (e) {
            debugPrint('‚ùå Error adding photo: $e');
            // Continue without photo
          }
        } else {
          debugPrint('üì∏ No photo to upload');
        }

        debugPrint('üöÄ Sending multipart request with photo...');

        // Send request
        final streamedResponse = await request.send();
        final response = await http.Response.fromStream(streamedResponse);

        debugPrint('üì° Response status: ${response.statusCode}');
        debugPrint('üì° Response body: ${response.body}');

        if (response.statusCode == 200) {
          final responseData = jsonDecode(response.body);

          if (responseData.containsKey('error')) {
            _showError('Request failed: ${responseData['error']}');
          } else if (responseData.containsKey('request_id')) {
            _showSuccess(
              'Delivery request posted successfully! Waiting for riders...',
            );
            Navigator.pop(context);
          } else {
            _showError('Unexpected response from server');
          }
        } else if (response.statusCode == 400) {
          _showError('Bad request: Please check all fields');
        } else if (response.statusCode == 403) {
          await _clearSession();
          _showError('Session expired. Please log in again.');
          Future.delayed(const Duration(seconds: 2), () {
            Navigator.pushNamedAndRemoveUntil(
              context,
              '/login',
              (route) => false,
            );
          });
        } else {
          _showError('Server error: ${response.statusCode}');
        }
      } catch (e) {
        debugPrint('‚ùå Error: $e');
        _showError('Network error: Please check your internet connection');
      } finally {
        setState(() {
          _isLoading = false;
        });
      }
    } else {
      // Show validation errors
      String errorMessage = 'Please complete the following:\n';
      if (_pickupPosition == null) errorMessage += '‚Ä¢ Set pickup location\n';
      if (_dropoffPosition == null) errorMessage += '‚Ä¢ Set dropoff location\n';
      if (_parcelSize == null) errorMessage += '‚Ä¢ Select parcel size\n';
      if (_paymentMethod == null) errorMessage += '‚Ä¢ Select payment method\n';
      if (!_formKey.currentState!.validate())
        errorMessage += '‚Ä¢ Fix form errors';

      _showError(errorMessage);
    }
  }

  // Helper methods
  Future<bool> _verifySession() async {
    final sessionId = await _getSessionId();
    if (sessionId == null) return false;

    try {
      final response = await http.get(
        Uri.parse('https://chareta.com/riderhub/api/api.php?action=profile'),
        headers: {'X-Session-Id': sessionId},
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        return data['error'] == null;
      }
      return false;
    } catch (e) {
      debugPrint('Session verification error: $e');
      return false;
    }
  }

  Future<void> _clearSession() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('session_id');
    await prefs.remove('user_name');
    await prefs.remove('user_phone');
    await prefs.remove('user_type');
  }

  Future<String?> _getSessionId() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString('session_id');
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 4),
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
      ),
    );
  }

  void _showSuccess(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            Icon(Icons.check_circle, color: Colors.white, size: 20),
            SizedBox(width: 8),
            Expanded(child: Text(message)),
          ],
        ),
        backgroundColor: Colors.green,
        duration: const Duration(seconds: 3),
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
      ),
    );
  }

  void _setPickupLocation() {
    setState(() {
      _isSettingPickup = true;
    });
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          'Tap on map to set ${_isSettingPickup ? 'pickup' : 'dropoff'} location',
        ),
        backgroundColor: Color(0xFF667eea),
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
      ),
    );
  }

  void _setDropoffLocation() {
    setState(() {
      _isSettingPickup = false;
    });
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          'Tap on map to set ${_isSettingPickup ? 'pickup' : 'dropoff'} location',
        ),
        backgroundColor: Color(0xFF667eea),
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
      ),
    );
  }

  void _handleMapTap(LatLng position) {
    setState(() {
      if (_isSettingPickup) {
        _pickupPosition = position;
      } else {
        _dropoffPosition = position;
      }
    });
  }

  void _clearPickupLocation() {
    setState(() {
      _pickupPosition = null;
    });
  }

  void _clearDropoffLocation() {
    setState(() {
      _dropoffPosition = null;
    });
  }

  @override
  void dispose() {
    _suggestedFareController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(
          'Create Delivery Request',
          style: GoogleFonts.inter(
            fontSize: 20,
            fontWeight: FontWeight.w700,
            color: Colors.white,
          ),
        ),
        backgroundColor: const Color(0xFF667eea),
        foregroundColor: Colors.white,
        elevation: 0,
        centerTitle: false,
        shape: const RoundedRectangleBorder(
          borderRadius: BorderRadius.vertical(bottom: Radius.circular(16)),
        ),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Location Section Header
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 8,
                ),
                decoration: BoxDecoration(
                  color: const Color(0xFF667eea).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  children: [
                    Icon(
                      Icons.location_on,
                      color: const Color(0xFF667eea),
                      size: 20,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      'Delivery Locations',
                      style: GoogleFonts.inter(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: const Color(0xFF667eea),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 12),
              Text(
                'Set pickup and dropoff locations using search or map',
                style: GoogleFonts.inter(
                  fontSize: 14,
                  color: Colors.grey.shade600,
                ),
              ),
              const SizedBox(height: 20),

              // Search Buttons Card
              Card(
                elevation: 2,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    children: [
                      Text(
                        'Search Address',
                        style: GoogleFonts.inter(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                          color: const Color(0xFF333333),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Text(
                        'Find exact locations by searching',
                        style: GoogleFonts.inter(
                          fontSize: 13,
                          color: Colors.grey.shade600,
                        ),
                      ),
                      const SizedBox(height: 16),
                      Row(
                        children: [
                          Expanded(
                            child: _buildSearchButton(
                              icon: Icons.location_on,
                              label: 'Search Pickup',
                              color: Colors.green,
                              onPressed: () =>
                                  _searchAddressWithSuggestions(isPickup: true),
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: _buildSearchButton(
                              icon: Icons.location_searching,
                              label: 'Search Dropoff',
                              color: Colors.red,
                              onPressed: () => _searchAddressWithSuggestions(
                                isPickup: false,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 20),

              // Map Section
              Container(
                height: 280,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.grey.withOpacity(0.1),
                      blurRadius: 10,
                      spreadRadius: 2,
                      offset: const Offset(0, 3),
                    ),
                  ],
                ),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(16),
                  child: Stack(
                    children: [
                      GoogleMap(
                        initialCameraPosition: CameraPosition(
                          target: _pickupPosition ?? _harare,
                          zoom: 15,
                        ),
                        markers: {
                          if (_pickupPosition != null)
                            Marker(
                              markerId: const MarkerId('pickup'),
                              position: _pickupPosition!,
                              icon: BitmapDescriptor.defaultMarkerWithHue(
                                BitmapDescriptor.hueGreen,
                              ),
                              infoWindow: const InfoWindow(
                                title: 'Pickup Location',
                              ),
                            ),
                          if (_dropoffPosition != null)
                            Marker(
                              markerId: const MarkerId('dropoff'),
                              position: _dropoffPosition!,
                              icon: BitmapDescriptor.defaultMarkerWithHue(
                                BitmapDescriptor.hueRed,
                              ),
                              infoWindow: const InfoWindow(
                                title: 'Dropoff Location',
                              ),
                            ),
                        },
                        polylines: {
                          if (_pickupPosition != null &&
                              _dropoffPosition != null)
                            Polyline(
                              polylineId: const PolylineId('route'),
                              points: [_pickupPosition!, _dropoffPosition!],
                              color: const Color(0xFF667eea),
                              width: 3,
                            ),
                        },
                        onMapCreated: (GoogleMapController controller) {
                          _mapController = controller;
                        },
                        onTap: _handleMapTap,
                      ),
                      // Map Controls
                      Positioned(
                        bottom: 12,
                        right: 12,
                        child: Column(
                          children: [
                            FloatingActionButton.small(
                              onPressed: _setPickupLocation,
                              backgroundColor: _isSettingPickup
                                  ? Colors.green
                                  : Colors.white,
                              foregroundColor: _isSettingPickup
                                  ? Colors.white
                                  : Colors.green,
                              child: const Icon(Icons.location_on),
                            ),
                            const SizedBox(height: 8),
                            FloatingActionButton.small(
                              onPressed: _setDropoffLocation,
                              backgroundColor: !_isSettingPickup
                                  ? Colors.red
                                  : Colors.white,
                              foregroundColor: !_isSettingPickup
                                  ? Colors.white
                                  : Colors.red,
                              child: const Icon(Icons.location_searching),
                            ),
                          ],
                        ),
                      ),
                      // Current mode indicator
                      Positioned(
                        top: 12,
                        left: 12,
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 6,
                          ),
                          decoration: BoxDecoration(
                            color: _isSettingPickup ? Colors.green : Colors.red,
                            borderRadius: BorderRadius.circular(20),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.1),
                                blurRadius: 4,
                                spreadRadius: 1,
                              ),
                            ],
                          ),
                          child: Text(
                            _isSettingPickup
                                ? 'Setting Pickup'
                                : 'Setting Dropoff',
                            style: GoogleFonts.inter(
                              color: Colors.white,
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 20),

              // Clear Buttons
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton.icon(
                      onPressed: _pickupPosition == null
                          ? null
                          : _clearPickupLocation,
                      icon: Icon(
                        Icons.clear,
                        size: 16,
                        color: Colors.grey.shade700,
                      ),
                      label: Text(
                        'Clear Pickup',
                        style: GoogleFonts.inter(
                          fontSize: 14,
                          color: Colors.grey.shade700,
                        ),
                      ),
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 12),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        side: BorderSide(color: Colors.grey.shade300),
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: OutlinedButton.icon(
                      onPressed: _dropoffPosition == null
                          ? null
                          : _clearDropoffLocation,
                      icon: Icon(
                        Icons.clear,
                        size: 16,
                        color: Colors.grey.shade700,
                      ),
                      label: Text(
                        'Clear Dropoff',
                        style: GoogleFonts.inter(
                          fontSize: 14,
                          color: Colors.grey.shade700,
                        ),
                      ),
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 12),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        side: BorderSide(color: Colors.grey.shade300),
                      ),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 32),

              // Package Details Section
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 8,
                ),
                decoration: BoxDecoration(
                  color: const Color(0xFF667eea).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  children: [
                    Icon(
                      Icons.inventory,
                      color: const Color(0xFF667eea),
                      size: 20,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      'Package Details',
                      style: GoogleFonts.inter(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: const Color(0xFF667eea),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 20),

              // Parcel Size Dropdown
              _buildFormField(
                label: 'Parcel Size *',
                child: DropdownButtonFormField<String>(
                  value: _parcelSize,
                  decoration: InputDecoration(
                    hintText: 'Select parcel size',
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade300),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade300),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: const BorderSide(
                        color: Color(0xFF667eea),
                        width: 2,
                      ),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 16,
                    ),
                  ),
                  items: ['Small', 'Medium', 'Large']
                      .map(
                        (size) => DropdownMenuItem(
                          value: size,
                          child: Text(
                            size,
                            style: GoogleFonts.inter(fontSize: 14),
                          ),
                        ),
                      )
                      .toList(),
                  onChanged: (value) => setState(() => _parcelSize = value),
                  validator: (value) =>
                      value == null ? 'Please select parcel size' : null,
                  style: GoogleFonts.inter(fontSize: 14),
                ),
              ),

              const SizedBox(height: 16),

              // Suggested Fare
              _buildFormField(
                label: 'Suggested Fare (USD) *',
                child: TextFormField(
                  controller: _suggestedFareController,
                  keyboardType: TextInputType.numberWithOptions(decimal: true),
                  decoration: InputDecoration(
                    hintText: 'Enter amount you\'re willing to pay',
                    prefixIcon: Icon(
                      Icons.attach_money,
                      color: Colors.grey.shade600,
                    ),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade300),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade300),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: const BorderSide(
                        color: Color(0xFF667eea),
                        width: 2,
                      ),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 16,
                    ),
                  ),
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'Please enter suggested fare';
                    }
                    final amount = double.tryParse(value);
                    if (amount == null || amount <= 0) {
                      return 'Please enter a valid amount';
                    }
                    return null;
                  },
                  style: GoogleFonts.inter(fontSize: 14),
                ),
              ),

              const SizedBox(height: 20),

              // Payment Method
              Text(
                'Payment Method *',
                style: GoogleFonts.inter(
                  fontSize: 15,
                  fontWeight: FontWeight.w600,
                  color: const Color(0xFF333333),
                ),
              ),
              const SizedBox(height: 12),
              Card(
                elevation: 1,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                  side: BorderSide(color: Colors.grey.shade200),
                ),
                child: Column(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: const Color(0xFF667eea).withOpacity(0.05),
                        borderRadius: const BorderRadius.vertical(
                          top: Radius.circular(12),
                        ),
                      ),
                      child: Row(
                        children: [
                          Icon(
                            Icons.payment,
                            color: const Color(0xFF667eea),
                            size: 20,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            'Select payment method',
                            style: GoogleFonts.inter(
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                              color: const Color(0xFF667eea),
                            ),
                          ),
                        ],
                      ),
                    ),
                    RadioListTile<String>(
                      title: Text(
                        'EcoCash',
                        style: GoogleFonts.inter(fontSize: 14),
                      ),
                      subtitle: Text(
                        'Mobile money payment',
                        style: GoogleFonts.inter(
                          fontSize: 12,
                          color: Colors.grey.shade600,
                        ),
                      ),
                      value: 'ecocash',
                      groupValue: _paymentMethod,
                      onChanged: (value) =>
                          setState(() => _paymentMethod = value),
                      activeColor: const Color(0xFF667eea),
                      tileColor: Colors.white,
                    ),
                    const Divider(height: 0),
                    RadioListTile<String>(
                      title: Text(
                        'Cash on Delivery',
                        style: GoogleFonts.inter(fontSize: 14),
                      ),
                      subtitle: Text(
                        'Pay when package is delivered',
                        style: GoogleFonts.inter(
                          fontSize: 12,
                          color: Colors.grey.shade600,
                        ),
                      ),
                      value: 'cash',
                      groupValue: _paymentMethod,
                      onChanged: (value) =>
                          setState(() => _paymentMethod = value),
                      activeColor: const Color(0xFF667eea),
                      tileColor: Colors.white,
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Optional Photo Upload
              Card(
                elevation: 1,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                  side: BorderSide(color: Colors.grey.shade200),
                ),
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(
                            Icons.camera_alt,
                            color: const Color(0xFF667eea),
                            size: 20,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            'Parcel Photo (Optional)',
                            style: GoogleFonts.inter(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                              color: const Color(0xFF333333),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Add a photo to help riders identify your package',
                        style: GoogleFonts.inter(
                          fontSize: 13,
                          color: Colors.grey.shade600,
                        ),
                      ),
                      const SizedBox(height: 16),
                      ElevatedButton.icon(
                        onPressed: _pickPhoto,
                        icon: Icon(Icons.add_a_photo, size: 18),
                        label: Text(
                          'Add Photo',
                          style: GoogleFonts.inter(
                            fontSize: 14,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.white,
                          foregroundColor: const Color(0xFF667eea),
                          side: const BorderSide(color: Color(0xFF667eea)),
                          padding: const EdgeInsets.symmetric(
                            vertical: 12,
                            horizontal: 20,
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          elevation: 0,
                        ),
                      ),
                      if (_parcelPhoto != null) ...[
                        const SizedBox(height: 16),
                        Stack(
                          children: [
                            Container(
                              height: 120,
                              width: double.infinity,
                              decoration: BoxDecoration(
                                borderRadius: BorderRadius.circular(12),
                                image: DecorationImage(
                                  image: FileImage(_parcelPhoto!),
                                  fit: BoxFit.cover,
                                ),
                              ),
                            ),
                            Positioned(
                              top: 8,
                              right: 8,
                              child: Container(
                                decoration: BoxDecoration(
                                  color: Colors.black.withOpacity(0.6),
                                  shape: BoxShape.circle,
                                ),
                                child: IconButton(
                                  icon: const Icon(
                                    Icons.close,
                                    size: 18,
                                    color: Colors.white,
                                  ),
                                  onPressed: () {
                                    setState(() {
                                      _parcelPhoto = null;
                                    });
                                  },
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 32),

              // Submit Button
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _submitRequest,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF667eea),
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 18),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 2,
                    shadowColor: const Color(0xFF667eea).withOpacity(0.3),
                  ),
                  child: _isLoading
                      ? SizedBox(
                          height: 24,
                          width: 24,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              Colors.white,
                            ),
                          ),
                        )
                      : Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.send, size: 18),
                            const SizedBox(width: 8),
                            Text(
                              'Post Delivery Request',
                              style: GoogleFonts.inter(
                                fontSize: 16,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ],
                        ),
                ),
              ),

              const SizedBox(height: 16),

              // Info Card
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: const Color(0xFF667eea).withOpacity(0.05),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: const Color(0xFF667eea).withOpacity(0.1),
                  ),
                ),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Icon(
                      Icons.info_outline,
                      color: const Color(0xFF667eea),
                      size: 20,
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Make sure to set both pickup and dropoff locations, select parcel size, payment method, and enter a fare amount.',
                        style: GoogleFonts.inter(
                          fontSize: 13,
                          color: const Color(0xFF667eea),
                          height: 1.5,
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildFormField({required String label, required Widget child}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: GoogleFonts.inter(
            fontSize: 14,
            fontWeight: FontWeight.w500,
            color: const Color(0xFF333333),
          ),
        ),
        const SizedBox(height: 8),
        child,
      ],
    );
  }

  Widget _buildSearchButton({
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onPressed,
  }) {
    return ElevatedButton.icon(
      onPressed: onPressed,
      icon: Icon(icon, size: 18),
      label: Text(
        label,
        style: GoogleFonts.inter(fontSize: 14, fontWeight: FontWeight.w500),
      ),
      style: ElevatedButton.styleFrom(
        backgroundColor: color,
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(vertical: 14),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        elevation: 1,
      ),
    );
  }
}

// Address Search Dialog with Suggestions
class AddressSearchDialog extends StatefulWidget {
  final bool isPickup;
  final Future<List<Map<String, dynamic>>> Function(String) onSearch;

  const AddressSearchDialog({
    super.key,
    required this.isPickup,
    required this.onSearch,
  });

  @override
  State<AddressSearchDialog> createState() => _AddressSearchDialogState();
}

class _AddressSearchDialogState extends State<AddressSearchDialog> {
  final TextEditingController _searchController = TextEditingController();
  List<Map<String, dynamic>> _suggestions = [];
  bool _isSearching = false;

  @override
  void initState() {
    super.initState();
    _searchController.addListener(_onSearchChanged);
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  void _onSearchChanged() async {
    final query = _searchController.text.trim();
    if (query.length >= 2) {
      setState(() {
        _isSearching = true;
      });

      final results = await widget.onSearch(query);

      setState(() {
        _suggestions = results;
        _isSearching = false;
      });
    } else {
      setState(() {
        _suggestions.clear();
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.white,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Container(
        constraints: const BoxConstraints(maxHeight: 500),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: const Color(0xFF667eea),
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(20),
                ),
              ),
              child: Row(
                children: [
                  Icon(
                    widget.isPickup
                        ? Icons.location_on
                        : Icons.location_searching,
                    color: Colors.white,
                    size: 24,
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      widget.isPickup
                          ? 'Search Pickup Address'
                          : 'Search Dropoff Address',
                      style: GoogleFonts.inter(
                        fontSize: 18,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // Search Field
            Padding(
              padding: const EdgeInsets.all(20),
              child: TextField(
                controller: _searchController,
                autofocus: true,
                decoration: InputDecoration(
                  hintText: 'Search area, street, or city...',
                  prefixIcon: Icon(Icons.search, color: Colors.grey.shade500),
                  filled: true,
                  fillColor: Colors.grey.shade50,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide.none,
                  ),
                  contentPadding: const EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: 14,
                  ),
                  suffixIcon: _searchController.text.isNotEmpty
                      ? IconButton(
                          icon: Icon(Icons.clear, color: Colors.grey.shade500),
                          onPressed: () {
                            _searchController.clear();
                            setState(() {
                              _suggestions.clear();
                            });
                          },
                        )
                      : null,
                ),
                style: GoogleFonts.inter(fontSize: 14),
              ),
            ),

            // Suggestions or Loading
            Expanded(child: _buildSuggestionsList()),

            // Divider
            const Divider(height: 0),

            // Footer
            Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(context),
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        side: BorderSide(color: Colors.grey.shade300),
                      ),
                      child: Text(
                        'Cancel',
                        style: GoogleFonts.inter(
                          fontSize: 14,
                          fontWeight: FontWeight.w500,
                          color: Colors.grey.shade700,
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: _searchController.text.trim().isEmpty
                          ? null
                          : () => Navigator.pop(
                              context,
                              _searchController.text.trim(),
                            ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF667eea),
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        elevation: 0,
                      ),
                      child: Text(
                        'Search',
                        style: GoogleFonts.inter(
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSuggestionsList() {
    if (_isSearching) {
      return const Center(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            CircularProgressIndicator(
              strokeWidth: 2,
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF667eea)),
            ),
            SizedBox(height: 12),
            Text(
              'Searching...',
              style: TextStyle(fontSize: 14, color: Colors.grey),
            ),
          ],
        ),
      );
    }

    if (_suggestions.isEmpty && _searchController.text.length >= 2) {
      return Center(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.search_off, size: 48, color: Colors.grey.shade300),
            const SizedBox(height: 12),
            Text(
              'No results found',
              style: GoogleFonts.inter(
                fontSize: 16,
                color: Colors.grey.shade500,
              ),
            ),
            const SizedBox(height: 8),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 40),
              child: Text(
                'Try searching for areas in Zimbabwe like:\n‚Ä¢ Harare ‚Ä¢ Bulawayo ‚Ä¢ Avondale ‚Ä¢ Mbare',
                textAlign: TextAlign.center,
                style: GoogleFonts.inter(
                  fontSize: 13,
                  color: Colors.grey.shade500,
                ),
              ),
            ),
          ],
        ),
      );
    }

    if (_suggestions.isEmpty) {
      return Center(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.location_on, size: 48, color: Colors.grey.shade300),
            const SizedBox(height: 12),
            Text(
              'Start typing to search',
              style: GoogleFonts.inter(
                fontSize: 16,
                color: Colors.grey.shade500,
              ),
            ),
            const SizedBox(height: 8),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 40),
              child: Text(
                'Search for cities, suburbs, or streets in Zimbabwe',
                textAlign: TextAlign.center,
                style: GoogleFonts.inter(
                  fontSize: 13,
                  color: Colors.grey.shade500,
                ),
              ),
            ),
          ],
        ),
      );
    }

    return ListView.separated(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      itemCount: _suggestions.length,
      separatorBuilder: (context, index) =>
          Divider(height: 1, color: Colors.grey.shade200),
      itemBuilder: (context, index) {
        final suggestion = _suggestions[index];
        return ListTile(
          contentPadding: const EdgeInsets.symmetric(
            vertical: 12,
            horizontal: 0,
          ),
          leading: Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: const Color(0xFF667eea).withOpacity(0.1),
              borderRadius: BorderRadius.circular(10),
            ),
            child: Icon(
              _getSuggestionIcon(suggestion['type']),
              color: const Color(0xFF667eea),
              size: 20,
            ),
          ),
          title: Text(
            _getShortAddress(suggestion['name']),
            style: GoogleFonts.inter(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: const Color(0xFF333333),
            ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
          subtitle: Text(
            suggestion['type'],
            style: GoogleFonts.inter(fontSize: 12, color: Colors.grey.shade600),
          ),
          trailing: Icon(
            Icons.arrow_forward_ios,
            size: 16,
            color: Colors.grey.shade400,
          ),
          onTap: () => Navigator.pop(context, suggestion['name']),
        );
      },
    );
  }

  IconData _getSuggestionIcon(String type) {
    switch (type.toLowerCase()) {
      case 'city':
        return Icons.location_city;
      case 'area':
        return Icons.place;
      case 'street':
        return Icons.line_weight_sharp;
      case 'district':
        return Icons.map;
      default:
        return Icons.location_on;
    }
  }

  String _getShortAddress(String fullAddress) {
    final parts = fullAddress.split(',');
    if (parts.length > 2) {
      return '${parts[0]}, ${parts[1]}';
    }
    return fullAddress;
  }
}
