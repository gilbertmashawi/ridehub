given the following api.php

"<?php
// api.php (Updated for customer picture upload, multipart registration, and admin customer view)
// Error reporting for debugging (remove or lower in production)
ini_set('display_errors', 0);
ini_set('display_startup_errors', 0);
error_reporting(0);

// Define a base URL for image display in the admin panel
// !! IMPORTANT: Adjust this to your actual base URL where 'uploads' folder is accessible
define('BASE_URL', 'https://chareta.com/riderhub/api/'); 

// MUST send JSON and CORS headers before output
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *'); // Adjust in production
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Session-Id');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(204);
    exit;
}

require_once 'config.php'; // must set up $pdo (PDO) and not produce any output

// Read JSON input (default for most actions)
$input = json_decode(file_get_contents('php://input'), true);
if (json_last_error() !== JSON_ERROR_NONE) {
    $input = [];
}
$action = $_GET['action'] ?? '';

// --- Helper to send JSON response ---
function sendJson($data, $statusCode = 200) {
    http_response_code($statusCode);
    echo json_encode($data);
    exit;
}

// --- Session helpers ---
// Start or resume session. If client sends X-Session-Id header, use it.
// Returns true if session started.
function startSessionFromHeader() {
    // If headers already sent, we cannot start a session
    if (headers_sent()) {
        return false;
    }
    // Support session id via header for stateless clients
    $headers = getallheaders_safe();
    if (!empty($headers['X-Session-Id'])) {
        // Use the provided session id
        session_id($headers['X-Session-Id']);
    } elseif (!empty($headers['x-session-id'])) {
        session_id($headers['x-session-id']);
    }
    // Start session if not already started
    if (session_status() !== PHP_SESSION_ACTIVE) {
        session_start();
    }
    return true;
}

// Safe wrapper for getallheaders (works on non-Apache too)
function getallheaders_safe() {
    if (function_exists('getallheaders')) {
        return getallheaders();
    }
    $headers = [];
    foreach ($_SERVER as $name => $value) {
        if (substr($name, 0, 5) == 'HTTP_') {
            $key = str_replace(' ', '-', ucwords(strtolower(str_replace('_', ' ', substr($name, 5)))));
            $headers[$key] = $value;
        }
    }
    return $headers;
}

// Validate session and return user object or null
function validateSession() {
    global $pdo;
    // Start/resume session (uses X-Session-Id if provided)
    startSessionFromHeader();
    if (empty($_SESSION['user_id'])) {
        return null;
    }
    $userId = intval($_SESSION['user_id']);
    try {
        // Fetch new columns: face_picture and id_front_picture (assuming they exist in the 'users' table)
        $stmt = $pdo->prepare("SELECT id, name, phone, user_type, face_picture, id_front_picture FROM users WHERE id = ?");
        $stmt->execute([$userId]);
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($user) {
            // return a simple object for convenience
            return (object)[
                'id' => intval($user['id']),
                'name' => $user['name'],
                'phone' => $user['phone'],
                'user_type' => $user['user_type'],
                'face_picture' => $user['face_picture'] ?? null,
                'id_front_picture' => $user['id_front_picture'] ?? null
            ];
        }
    } catch (PDOException $e) {
        error_log("Session validation DB error: " . $e->getMessage());
    }
    return null;
}

// Create session for user id and user_type. Returns session id.
function createSessionForUser($userId, $userType) {
    startSessionFromHeader();
    // Regenerate session id to avoid fixation
    session_regenerate_id(true);
    $_SESSION['user_id'] = $userId;
    $_SESSION['user_type'] = $userType;
    return session_id();
}

// Clear session (logout)
function destroySession() {
    startSessionFromHeader();
    $_SESSION = [];
    if (ini_get("session.use_cookies")) {
        $params = session_get_cookie_params();
        setcookie(session_name(), '', time() - 42000,
            $params["path"], $params["domain"],
            $params["secure"], $params["httponly"]
        );
    }
    session_destroy();
}

// Helper to upload file and return relative path
function uploadFile($file, $uploadDir, $prefix) {
    if (!isset($file) || $file['error'] !== UPLOAD_ERR_OK) {
        return null;
    }
    if (!is_dir($uploadDir)) {
        // Use 0755 for typical web server permissions
        if (!mkdir($uploadDir, 0755, true)) {
            error_log("Failed to create upload directory: $uploadDir");
            return null;
        }
    }
    $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
    $fileName = $prefix . '_' . uniqid() . '.' . $ext;
    $filePath = $uploadDir . $fileName;
    if (move_uploaded_file($file['tmp_name'], $filePath)) {
        // Return relative path starting from 'uploads/'
        $relativePath = str_replace(realpath(__DIR__), '', realpath($filePath));
        if (strpos($relativePath, '/uploads/') === 0) {
            return substr($relativePath, 1); // Remove leading slash
        }
        return 'uploads/' . basename($uploadDir) . '/' . $fileName; 
    }
    error_log("Failed to move uploaded file: " . $file['tmp_name'] . " to " . $filePath);
    return null;
}

// Admin check (updated to use session user_type directly)
function isAdmin() {
    startSessionFromHeader();
    return !empty($_SESSION['user_type']) && $_SESSION['user_type'] === 'admin';
}

// --- Routing ---
switch ($action) {
    case 'register':
        // Standard JSON register (left for compatibility if needed, but Flutter uses multipart)
        registerUser($input);
        break;
    case 'register_multipart':
        registerUserMultipart();
        break;
    case 'login':
        loginUser($input);
        break;
    case 'logout':
        logoutUser();
        break;
    case 'profile':
        getProfile();
        break;
    // case 'apply_rider':
    //     applyForRiderMultipart(); // Use the multipart version
    //     break;

    // case 'apply_rider':
    // header('Content-Type: application/json');

    // // Get the session_id from header (your Flutter sends the USER ID here)
    // $sessionId = $_SERVER['HTTP_X_SESSION_ID'] ?? $_SERVER['HTTP_X_SESSION_ID'] ?? '';
    
    // if (empty($sessionId)) {
    //     echo json_encode(['error' => 'No session provided']);
    //     exit;
    // }

    // // CRITICAL: Your Flutter app sends USER_ID as session_id → treat it as user_id
    // $userId = (int)$sessionId;

    // // Direct check — no PHP session needed
    // $stmt = $pdo->prepare("SELECT id, user_type FROM users WHERE id = ?");
    // $stmt->execute([$userId]);
    // $user = $stmt->fetch(PDO::FETCH_ASSOC);

    // if (!$user) {
    //     echo json_encode(['error' => 'Invalid user. Please login again.']);
    //     exit;
    // }

    // // Optional: Prevent non-customers from applying
    // // if ($user['user_type'] !== 'customer') {
    // //     echo json_encode(['error' => 'Only customers can apply']);
    // //     exit;
    // // }

    // // Check if already applied
    // $check = $pdo->prepare("SELECT 1 FROM rider_applications WHERE rider_id = ?");
    // $check->execute([$userId]);
    // if ($check->fetch()) {
    //     echo json_encode(['error' => 'You have already submitted an application']);
    //     exit;
    // }

    // // Generate unique rider code
    // do {
    //     $riderCode = 'RDR-' . strtoupper(substr(uniqid(), -6));
    //     $checkCode = $pdo->prepare("SELECT 1 FROM rider_applications WHERE custom_rider_id = ?");
    //     $checkCode->execute([$riderCode]);
    // } while ($checkCode->fetch());

    // // Required fields
    // $required = ['full_name', 'id_number', 'vehicle_type', 'vehicle_registration'];
    // foreach ($required as $field) {
    //     if (empty($_POST[$field] ?? '')) {
    //         echo json_encode(['error' => "Please fill: $field"]);
    //         exit;
    //     }
    // }

    // // Upload images
    // $uploadDir = 'uploads/rider_applications/';
    // if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);

    // $requiredImages = ['id_front_image', 'id_back_image', 'vehicle_front_image', 'vehicle_back_image'];
    // $paths = [];
    // foreach ($requiredImages as $field) {
    //     if (empty($_FILES[$field]['name'])) {
    //         echo json_encode(['error' => "Please upload: $field"]);
    //         exit;
    //     }
    //     $ext = pathinfo($_FILES[$field]['name'], PATHINFO_EXTENSION);
    //     $filename = $field . '_' . uniqid() . '.' . $ext;
    //     $path = $uploadDir . $filename;
    //     if (!move_uploaded_file($_FILES[$field]['tmp_name'], $path)) {
    //         echo json_encode(['error' => "Failed to upload $field"]);
    //         exit;
    //     }
    //     $paths[$field] = $path;
    // }

    // // Optional license
    // $licensePath = null;
    // if (!empty($_FILES['license_image']['name'])) {
    //     $ext = pathinfo($_FILES['license_image']['name'], PATHINFO_EXTENSION);
    //     $filename = 'license_image_' . uniqid() . '.' . $ext;
    //     $path = $uploadDir . $filename;
    //     if (move_uploaded_file($_FILES['license_image']['tmp_name'], $path)) {
    //         $licensePath = $path;
    //     }
    // }

    // // INSERT
    // try {
    //     $sql = "INSERT INTO rider_applications (
    //         rider_id, custom_rider_id, full_name, id_number, address, emergency_contact,
    //         vehicle_type, vehicle_model, vehicle_year, vehicle_registration, license_number,
    //         id_front_image, id_back_image, vehicle_front_image, vehicle_back_image, license_image, status
    //     ) VALUES (
    //         ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending'
    //     )";

    //     $stmt = $pdo->prepare($sql);
    //     $stmt->execute([
    //         $userId,
    //         $riderCode,
    //         $_POST['full_name'],
    //         $_POST['id_number'],
    //         $_POST['address'] ?? null,
    //         $_POST['emergency_contact'] ?? null,
    //         $_POST['vehicle_type'],
    //         $_POST['vehicle_model'] ?? null,
    //         $_POST['vehicle_year'] ?? null,
    //         $_POST['vehicle_registration'],
    //         $_POST['license_number'] ?? null,
    //         $paths['id_front_image'],
    //         $paths['id_back_image'],
    //         $paths['vehicle_front_image'],
    //         $paths['vehicle_back_image'],
    //         $licensePath
    //     ]);

    //     // Optional: Update user to pending_rider
    //     $pdo->prepare("UPDATE users SET user_type = 'pending_rider' WHERE id = ?")->execute([$userId]);

    //     echo json_encode([
    //         'success' => true,
    //         'message' => 'Application submitted successfully!',
    //         'rider_code' => $riderCode
    //     ]);

    // } catch (Exception $e) {
    //     echo json_encode(['error' => 'DB Error: ' . $e->getMessage()]);
    // }
    // break;

case 'apply_rider':
    header('Content-Type: application/json');

    $sessionHeader = trim($_SERVER['HTTP_X_SESSION_ID'] ?? '');

    if (empty($sessionHeader)) {
        echo json_encode(['error' => 'No session provided']);
        exit;
    }

    $userId = null;

    // 1. NEW WAY: Real session (long string) — look it up in sessions table
    if (strlen($sessionHeader) > 15 && !is_numeric($sessionHeader)) {
        $stmt = $pdo->prepare("SELECT user_id FROM sessions WHERE session_id = ? AND expires > NOW()");
        $stmt->execute([$sessionHeader]);
        if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $userId = (int)$row['user_id'];
        }
    }

    // 2. OLD WAY: Direct user_id (like 45) — accept it anyway
    if (!$userId && is_numeric($sessionHeader) && $sessionHeader > 0) {
        $userId = (int)$sessionHeader;
    }

    // 3. LAST RESORT: Try to recover from old broken session using get_session
    if (!$userId) {
        $fallback = @file_get_contents("https://chareta.com/riderhub/api/api.php?action=get_session", false, stream_context_create([
            'http' => ['header' => "X-User-Id: " . (int)$sessionHeader]
        ]));
        if ($fallback) {
            $json = json_decode($fallback, true);
            if ($json && !empty($json['session_id']) && strlen($json['session_id']) > 20) {
                $sessionHeader = $json['session_id'];
                $stmt = $pdo->prepare("SELECT user_id FROM sessions WHERE session_id = ? AND expires > NOW()");
                $stmt->execute([$sessionHeader]);
                if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
                    $userId = (int)$row['user_id'];
                }
            }
        }
    }

    // FINAL CHECK
    if (!$userId || $userId <= 0) {
        echo json_encode(['error' => 'Invalid session. Please restart app and login again.']);
        exit;
    }

    // Verify user exists
    $stmt = $pdo->prepare("SELECT id FROM users WHERE id = ?");
    $stmt->execute([$userId]);
    if (!$stmt->fetch()) {
        echo json_encode(['error' => 'User not found.']);
        exit;
    }

    // Check if already applied
    $check = $pdo->prepare("SELECT 1 FROM rider_applications WHERE rider_id = ?");
    $check->execute([$userId]);
    if ($check->fetch()) {
        echo json_encode(['error' => 'You have already applied']);
        exit;
    }

    // Generate rider code
    do {
        $riderCode = 'RDR-' . strtoupper(substr(uniqid(), -6));
        $check = $pdo->prepare("SELECT 1 FROM rider_applications WHERE custom_rider_id = ?");
        $check->execute([$riderCode]);
    } while ($check->fetch());

    // Required fields
    $required = ['full_name', 'id_number', 'vehicle_type', 'vehicle_registration'];
    foreach ($required as $f) {
        if (empty($_POST[$f] ?? '')) {
            echo json_encode(['error' => "Missing: $f"]);
            exit;
        }
    }

    // Upload images
    $uploadDir = 'uploads/rider_applications/';
    if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);

    $requiredImages = ['id_front_image', 'id_back_image', 'vehicle_front_image', 'vehicle_back_image'];
    $paths = [];
    foreach ($requiredImages as $field) {
        if (empty($_FILES[$field]['name']) || $_FILES[$field]['error'] !== 0) {
            echo json_encode(['error' => "Upload failed: $field"]);
            exit;
        }
        $ext = pathinfo($_FILES[$field]['name'], PATHINFO_EXTENSION);
        $filename = $field . '_' . uniqid() . '.' . strtolower($ext);
        $path = $uploadDir . $filename;
        if (!move_uploaded_file($_FILES[$field]['tmp_name'], $path)) {
            echo json_encode(['error' => "Save failed: $field"]);
            exit;
        }
        $paths[$field] = $path;
    }

    $licensePath = null;
    if (!empty($_FILES['license_image']['name']) && $_FILES['license_image']['error'] === 0) {
        $ext = pathinfo($_FILES['license_image']['name'], PATHINFO_EXTENSION);
        $filename = 'license_' . uniqid() . '.' . strtolower($ext);
        $path = $uploadDir . $filename;
        if (move_uploaded_file($_FILES['license_image']['tmp_name'], $path)) {
            $licensePath = $path;
        }
    }

    // INSERT
    try {
        $sql = "INSERT INTO rider_applications (
            rider_id, custom_rider_id, full_name, id_number, address, emergency_contact,
            vehicle_type, vehicle_model, vehicle_year, vehicle_registration, license_number,
            id_front_image, id_back_image, vehicle_front_image, vehicle_back_image, license_image, status
        ) VALUES (
            ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending'
        )";

        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            $userId, $riderCode,
            $_POST['full_name'], $_POST['id_number'],
            $_POST['address'] ?? null, $_POST['emergency_contact'] ?? null,
            $_POST['vehicle_type'], $_POST['vehicle_model'] ?? null,
            $_POST['vehicle_year'] ?? null, $_POST['vehicle_registration'],
            $_POST['license_number'] ?? null,
            $paths['id_front_image'], $paths['id_back_image'],
            $paths['vehicle_front_image'], $paths['vehicle_back_image'],
            $licensePath
        ]);

        // Update user
        $pdo->prepare("UPDATE users SET user_type = 'pending_rider' WHERE id = ?")->execute([$userId]);

        echo json_encode([
            'success' => true,
            'message' => 'Application submitted!',
            'rider_code' => $riderCode
        ]);
    } catch (Exception $e) {
        echo json_encode(['error' => 'DB Error: ' . $e->getMessage()]);
    }
    exit;   
    case 'send_otp':
        sendOTP($input);
        break;
    case 'verify_otp':
        verifyOTP($input);
        break;
    case 'google_login':
        handleGoogleLogin($input);
        break;
    case 'admin_login':
        adminLogin(); // Added missing admin_login endpoint
        break;
    case 'admin_riders':
        // Admin-only
        if (!isAdmin()) {
            sendJson(['error' => 'Admin access required'], 403);
        }
        if ($_SERVER['REQUEST_METHOD'] == 'GET') {
            getAllRiderApplications();
        } elseif ($_SERVER['REQUEST_METHOD'] == 'POST') {
            $input = json_decode(file_get_contents('php://input'), true);
            $riderId = $input['rider_id'] ?? '';
            $actionType = $input['action'] ?? ''; // 'approve' or 'reject'
            if ($actionType == 'approve') {
                approveRider($riderId, $input);
            } elseif ($actionType == 'reject') {
                rejectRider($riderId, $input);
            } else {
                sendJson(['error' => 'Invalid action'], 400);
            }
        } else {
            sendJson(['error' => 'Method not allowed'], 405);
        }
        break;
    case 'admin_customers':
        // New Admin-only endpoint for customers
        if (!isAdmin()) {
            sendJson(['error' => 'Admin access required'], 403);
        }
        if ($_SERVER['REQUEST_METHOD'] == 'GET') {
            getAllCustomerApplications();
        } else {
            sendJson(['error' => 'Method not allowed'], 405);
        }
        break;
    case 'requests':
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            createRequest($input);
        } else {
            getRequests($input);
        }
        break;
    case 'requests_nearby':
        getNearbyRequests($input);
        break;

    case 'rider_application_status':
    header('Content-Type: application/json');

    // === METHOD 1: Try proper session first (recommended) ===
    if (startSessionFromHeader()) {
        if (!empty($_SESSION['user_id'])) {
            $userId = (int)$_SESSION['user_id'];
        }
    }

    // === METHOD 2: Fallback — if no session, check if header is numeric user_id (your current Flutter bug) ===
    if (empty($userId)) {
        $header = $_SERVER['HTTP_X_SESSION_ID'] ?? $_SERVER['HTTP_X_SESSION_ID'] ?? '';
        if (is_numeric($header) && $header > 0) {
            $userId = (int)$header;
        }
    }

    if (empty($userId)) {
        echo json_encode(['status' => 'not_applied']);
        exit;
    }

    try {
        $stmt = $pdo->prepare("
            SELECT status, custom_rider_id AS rider_code, rejection_reason
            FROM rider_applications
            WHERE rider_id = ?
            ORDER BY applied_at DESC
            LIMIT 1
        ");
        $stmt->execute([$userId]);
        $app = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$app) {
            echo json_encode(['status' => 'not_applied']);
        } else {
            echo json_encode([
                'status' => $app['status'],
                'rider_code' => $app['rider_code'] ?? null,
                'rejection_reason' => $app['rejection_reason'] ?? null
            ]);
        }
    } catch (Exception $e) {
        error_log("rider_application_status error: " . $e->getMessage());
        echo json_encode(['status' => 'not_applied']);
    }
    exit;
    case 'offers':
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            // If path contains requests/{id}/offers (original design), try to parse it
            if (strpos($_SERVER['REQUEST_URI'], 'requests/') !== false && strpos($_SERVER['REQUEST_URI'], 'offers') !== false) {
                // naive extraction: /.../requests/{id}/offers
                $parts = explode('/', trim($_SERVER['REQUEST_URI'], '/'));
                $reqIndex = array_search('requests', $parts);
                if ($reqIndex !== false && isset($parts[$reqIndex + 1])) {
                    $requestId = intval($parts[$reqIndex + 1]);
                    createOffer($requestId, $input);
                } else {
                    sendJson(['error' => 'Invalid endpoint'], 400);
                }
            } else {
                // Fallback: create offer with request_id in body
                $requestId = intval($input['request_id'] ?? 0);
                createOffer($requestId, $input);
            }
        } else {
            // GET offers for request via ?request_id=123
            $requestId = intval($_GET['request_id'] ?? 0);
            if ($requestId <= 0) {
                sendJson(['error' => 'Missing request_id'], 400);
            }
            getOffersForRequest($requestId);
        }
        break;
    case 'offers_accept':
        // Accept offer endpoint (POST) with offer_id in URL or body
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            sendJson(['error' => 'Method not allowed'], 405);
        }
        $offerId = intval($_GET['offer_id'] ?? $input['offer_id'] ?? 0);
        if ($offerId <= 0) sendJson(['error' => 'Missing offer_id'], 400);
        acceptOffer($offerId, $input);
        break;
    case 'deliveries_status':
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $deliveryId = intval($input['delivery_id'] ?? ($_GET['delivery_id'] ?? 0));
            if ($deliveryId <= 0) sendJson(['error' => 'Missing delivery_id'], 400);
            updateDeliveryStatus($deliveryId, $input);
        } else {
            sendJson(['error' => 'Method not allowed'], 405);
        }
        break;
    case 'deliveries_pod':
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $deliveryId = intval($input['delivery_id'] ?? ($_GET['delivery_id'] ?? 0));
            if ($deliveryId <= 0) sendJson(['error' => 'Missing delivery_id'], 400);
            // For file uploads, client must send multipart/form-data; keep compatibility with $_FILES
            uploadPod($deliveryId, $_FILES['photo'] ?? null, $input);
        } else {
            sendJson(['error' => 'Method not allowed'], 405);
        }
        break;
    case 'location_update':
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            updateLocation($input);
        } else {
            sendJson(['error' => 'Method not allowed'], 405);
        }
        break;
    case 'deliveries_track':
        $deliveryId = intval($_GET['delivery_id'] ?? ($input['delivery_id'] ?? 0));
        if ($deliveryId <= 0) sendJson(['error' => 'Missing delivery_id'], 400);
        trackDelivery($deliveryId);
        break;

    // case 'rider_application_status':
    //     getRiderApplicationStatus();
    //     break;

    case 'clear_rider_application':
    clearRiderApplication();
    break;

    case 'get_session':
    header('Content-Type: application/json');
    $userId = (int)($_SERVER['HTTP_X_USER_ID'] ?? 0);
    if ($userId > 0) {
        $realSession = createSessionForUser($userId, getUserType($userId));
        echo json_encode(['session_id' => $realSession]);
    } else {
        http_response_code(400);
        echo json_encode(['error' => 'invalid']);
    }
    exit;

    case 'upload_image':
        uploadImage();
        break;

    default:
        sendJson(['error' => 'Invalid action'], 400);
}

// ----------------------
// Implementations
// ----------------------

// Register user (creates account and starts session)
function registerUser($data) {
    global $pdo;
    $name = trim($data['name'] ?? '');
    $phone = trim($data['phone'] ?? '');
    $password = $data['password'] ?? '';
    $userType = $data['user_type'] ?? 'customer';

    // Normalize phone example (adjust to your locale)
    if (preg_match('/^0(7|8)\d{8}$/', $phone)) {
        $phone = '+263' . substr($phone, 1);
    }

    if (empty($name) || empty($phone) || empty($password)) {
        sendJson(['error' => 'Missing fields'], 400);
    }

    $passwordHash = password_hash($password, PASSWORD_DEFAULT);

    try {
        // Check exists
        $checkStmt = $pdo->prepare("SELECT id FROM users WHERE phone = ?");
        $checkStmt->execute([$phone]);
        if ($checkStmt->fetch()) {
            sendJson(['error' => 'Phone already exists'], 409);
        }

        // NOTE: This version does NOT save pictures, as it expects JSON input
        $stmt = $pdo->prepare("INSERT INTO users (name, phone, password_hash, user_type) VALUES (?, ?, ?, ?)");
        $stmt->execute([$name, $phone, $passwordHash, $userType]);
        $userId = intval($pdo->lastInsertId());

        if ($userType === 'rider') {
            $kycStmt = $pdo->prepare("INSERT INTO rider_applications (rider_id, status) VALUES (?, 'pending')");
            $kycStmt->execute([$userId]);
        }

        // Create session for the user
        $sessionId = createSessionForUser($userId, $userType);

        sendJson([
            'user_id' => $userId,
            'user_type' => $userType,
            'session_id' => $sessionId,
            'message' => 'Registration successful'
        ]);
    } catch (PDOException $e) {
        error_log("Register error: " . $e->getMessage());
        if ($e->getCode() == 23000 || strpos($e->getMessage(), 'Duplicate entry') !== false) {
            sendJson(['error' => 'Phone already exists'], 409);
        } else {
            sendJson(['error' => 'Database error occurred'], 500);
        }
    } catch (Exception $e) {
        error_log("Register unexpected error: " . $e->getMessage());
        sendJson(['error' => 'Server error during registration'], 500);
    }
}

// ADD THIS FUNCTION (anywhere with the other functions)
function clearRiderApplication() {
    global $pdo;
    $user = validateSession();
    if (!$user) {
        sendJson(['error' => 'Unauthorized'], 403);
    }

    // Only allow if currently rejected
    $stmt = $pdo->prepare("SELECT status FROM rider_applications WHERE rider_id = ?");
    $stmt->execute([$user->id]);
    $kyc = $stmt->fetch();

    if (!$kyc || $kyc['status'] !== 'rejected') {
        sendJson(['error' => 'No rejected application to clear'], 400);
    }

    try {
        $pdo->beginTransaction();

        // Option 1: Delete from rider_applications (recommended)
        $pdo->prepare("DELETE FROM rider_applications WHERE rider_id = ?")->execute([$user->id]);

        // Option 2: OR just reset status + clear images (if you want to keep history)
        // $pdo->prepare("UPDATE rider_applications SET status = 'pending', custom_rider_id = NULL WHERE rider_id = ?")->execute([$user->id]);

        // Reset user back to customer
        $pdo->prepare("UPDATE users SET user_type = 'customer' WHERE id = ?")->execute([$user->id]);

        $pdo->commit();

        sendJson(['success' => true, 'message' => 'Application cleared. You can now re-apply.']);
    } catch (Exception $e) {
        $pdo->rollBack();
        error_log("Clear rider app error: " . $e->getMessage());
        sendJson(['error' => 'Failed to clear application'], 500);
    }
}

// NEW Register user with file upload (MULTIPART VERSION)
function registerUserMultipart() {
    global $pdo;
    
    // Data is expected in $_POST and files in $_FILES
    $name = trim($_POST['name'] ?? '');
    $phone = trim($_POST['phone'] ?? '');
    $password = $_POST['password'] ?? '';
    $userType = $_POST['user_type'] ?? 'customer';

    // Files are in $_FILES
    $facePicture = $_FILES['face_picture'] ?? null;
    $idFrontPicture = $_FILES['id_front_picture'] ?? null;

    // Normalize phone example (adjust to your locale)
    if (preg_match('/^0(7|8)\d{8}$/', $phone)) {
        $phone = '+263' . substr($phone, 1);
    }

    if (empty($name) || empty($phone) || empty($password)) {
        sendJson(['error' => 'Missing required text fields'], 400);
    }
    
    // Check if required files are present and valid
    if (empty($facePicture) || $facePicture['error'] !== UPLOAD_ERR_OK ||
        empty($idFrontPicture) || $idFrontPicture['error'] !== UPLOAD_ERR_OK) {
        sendJson(['error' => 'Missing required picture files or upload error'], 400);
    }

    $passwordHash = password_hash($password, PASSWORD_DEFAULT);
    
    // Upload files
    $uploadDir = __DIR__ . '/uploads/customer_docs/';
    $facePath = uploadFile($facePicture, $uploadDir, 'face');
    $idFrontPath = uploadFile($idFrontPicture, $uploadDir, 'id_front');
    
    if (!$facePath || !$idFrontPath) {
        // Handle failed upload cleanup if necessary (omitted for brevity)
        sendJson(['error' => 'File upload failed on server'], 500);
    }

    try {
        // Check exists
        $checkStmt = $pdo->prepare("SELECT id FROM users WHERE phone = ?");
        $checkStmt->execute([$phone]);
        if ($checkStmt->fetch()) {
            sendJson(['error' => 'Phone already exists'], 409);
        }

        // Insert user with file paths (Assuming users table has 'face_picture' and 'id_front_picture' columns)
        $stmt = $pdo->prepare("INSERT INTO users (name, phone, password_hash, user_type, face_picture, id_front_picture) VALUES (?, ?, ?, ?, ?, ?)");
        $stmt->execute([$name, $phone, $passwordHash, $userType, $facePath, $idFrontPath]);
        $userId = intval($pdo->lastInsertId());
        
        // Create session for the user
        $sessionId = createSessionForUser($userId, $userType);

        sendJson([
            'user_id' => $userId,
            'user_type' => $userType,
            'session_id' => $sessionId,
            'message' => 'Registration successful with documents uploaded'
        ]);
        
    } catch (PDOException $e) {
        error_log("Register multipart error: " . $e->getMessage());
        if ($e->getCode() == 23000 || strpos($e->getMessage(), 'Duplicate entry') !== false) {
            sendJson(['error' => 'Phone already exists'], 409);
        } else {
            sendJson(['error' => 'Database error occurred'], 500);
        }
    } catch (Exception $e) {
        error_log("Register multipart unexpected error: " . $e->getMessage());
        sendJson(['error' => 'Server error during registration'], 500);
    }
}


// Login (starts session)
// function loginUser($data) {
//     global $pdo;
//     $phone = trim($data['phone'] ?? '');
//     $password = $data['password'] ?? '';

//     if (empty($phone) || empty($password)) {
//         sendJson(['error' => 'Missing credentials'], 400);
//     }

//     try {
//         $stmt = $pdo->prepare("SELECT id, password_hash, user_type FROM users WHERE phone = ?");
//         $stmt->execute([$phone]);
//         $user = $stmt->fetch(PDO::FETCH_ASSOC);
//         if ($user && password_verify($password, $user['password_hash'])) {
//             $userId = intval($user['id']);
//             $userType = $user['user_type'];

//             $sessionId = createSessionForUser($userId, $userType);

//             sendJson([
//                 'user_id' => $userId,
//                 'user_type' => $userType,
//                 'session_id' => $sessionId,
//                 'message' => 'Login successful'
//             ]);
//         } else {
//             sendJson(['error' => 'Invalid credentials'], 401);
//         }
//     } catch (PDOException $e) {
//         error_log("Login error: " . $e->getMessage());
//         sendJson(['error' => 'Database error occurred'], 500);
//     }
// }
function loginUser($data) {
    global $pdo;
    $phone = trim($data['phone'] ?? '');
    $password = $data['password'] ?? '';

    if (empty($phone) || empty($password)) {
        sendJson(['error' => 'Missing credentials'], 400);
    }

    try {
        // 1. Find user by phone (uses the format that currently works for you)
        $stmt = $pdo->prepare("SELECT id, password_hash, user_type FROM users WHERE phone = ?");
        $stmt->execute([$phone]);
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($user && password_verify($password, $user['password_hash'])) {
            $userId = intval($user['id']);
            $userType = $user['user_type'];

            // 2. CHECK RIDER KYC STATUS (The New Logic)
            $kycStmt = $pdo->prepare("SELECT status FROM rider_applications WHERE rider_id = ?");
            $kycStmt->execute([$userId]);
            $kyc = $kycStmt->fetch(PDO::FETCH_ASSOC);

            // 3. Dynamically override userType based on application status
            if ($kyc) {
                $kycStatus = $kyc['status'];
                
                if ($kycStatus === 'pending') {
                    // Application submitted but waiting for Admin review
                    $userType = 'pending_rider';
                } elseif ($kycStatus === 'approved') {
                    // Fully approved rider
                    $userType = 'rider';
                } else { 
                    // Rejected or archived status defaults back to customer
                    if ($userType !== 'admin') {
                        $userType = 'customer';
                    }
                }
            } 
            // If no KYC record exists, userType remains the value from the 'users' table (usually 'customer')

            // 4. Create session and return the dynamically determined userType
            $sessionId = createSessionForUser($userId, $userType);

            sendJson([
                'user_id' => $userId,
                'user_type' => $userType, // <-- This value determines the screen in Flutter
                'session_id' => $sessionId,
                'message' => 'Login successful'
            ]);
        } else {
            sendJson(['error' => 'Invalid credentials'], 401);
        }
    } catch (PDOException $e) {
        error_log("Login error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// function loginUser($data) {
//     global $pdo;
//     $phone = trim($data['phone'] ?? '');
//     $password = $data['password'] ?? '';

//     if (empty($phone) || empty($password)) {
//         sendJson(['error' => 'Missing credentials'], 400);
//     }

//     try {
//         // 1. Find user by phone (uses the format that currently works for you)
//         $stmt = $pdo->prepare("SELECT id, password_hash, user_type FROM users WHERE phone = ?");
//         $stmt->execute([$phone]);
//         $user = $stmt->fetch(PDO::FETCH_ASSOC);
        
//         if ($user && password_verify($password, $user['password_hash'])) {
//             $userId = intval($user['id']);
//             $userType = $user['user_type'];

//             // 2. CHECK RIDER KYC STATUS (The New Logic)
//             $kycStmt = $pdo->prepare("SELECT status FROM rider_applications WHERE rider_id = ?");
//             $kycStmt->execute([$userId]);
//             $kyc = $kycStmt->fetch(PDO::FETCH_ASSOC);

//             // 3. Dynamically override userType based on application status
//             if ($kyc) {
//                 $kycStatus = $kyc['status'];
                
//                 if ($kycStatus === 'pending') {
//                     // Application submitted but waiting for Admin review
//                     $userType = 'pending_rider';
//                 } elseif ($kycStatus === 'approved') {
//                     // Fully approved rider
//                     $userType = 'rider';
//                 } else { 
//                     // Rejected or archived status defaults back to customer
//                     if ($userType !== 'admin') {
//                         $userType = 'customer';
//                     }
//                 }
//             } 
//             // If no KYC record exists, userType remains the value from the 'users' table (usually 'customer')

//             // 4. Create session and return the dynamically determined userType
//             $sessionId = createSessionForUser($userId, $userType);

//             sendJson([
//                 'user_id' => $userId,
//                 'user_type' => $userType, // <-- This value determines the screen in Flutter
//                 'session_id' => $sessionId,
//                 'message' => 'Login successful'
//             ]);
//         } else {
//             sendJson(['error' => 'Invalid credentials'], 401);
//         }
//     } catch (PDOException $e) {
//         error_log("Login error: " . $e->getMessage());
//         sendJson(['error' => 'Database error occurred'], 500);
//     }
// }
// Logout
function logoutUser() {
    destroySession();
    sendJson(['message' => 'Logged out']);
}

// Profile (protected, extended for rider info and pictures)
function getProfile() {
    $user = validateSession();
    if (!$user) {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    
    // Add file paths from the validated session user object
    $response = [
        'id' => $user->id,
        'name' => $user->name,
        'phone' => $user->phone,
        'user_type' => $user->user_type,
        'face_picture' => $user->face_picture ? BASE_URL . $user->face_picture : null,
        'id_front_picture' => $user->id_front_picture ? BASE_URL . $user->id_front_picture : null,
    ];

    if (in_array($user->user_type, ['pending_rider', 'rider'])) {
        global $pdo;
        try {
            $kycStmt = $pdo->prepare("SELECT rider_code, status, vehicle_registration, id_number FROM rider_applications WHERE rider_id = ?");
            $kycStmt->execute([$user->id]);
            $kyc = $kycStmt->fetch(PDO::FETCH_ASSOC);
            if ($kyc) {
                $response['rider_status'] = $kyc['status'];
                $response['rider_code'] = $kyc['rider_code'];
                $response['vehicle_registration'] = $kyc['vehicle_registration'];
                $response['id_number'] = $kyc['id_number'];
            }
        } catch (PDOException $e) {
            error_log("Profile KYC error: " . $e->getMessage());
        }
    }
    sendJson($response);
}

// Send OTP (for phone verification during register/login)
function sendOTP($data) {
    global $pdo;
    $phone = $data['phone'] ?? '';
    if (empty($phone)) {
        sendJson(['error' => 'Missing phone'], 400);
    }
    // Normalize phone if needed
    if (preg_match('/^0(7|8)\d{8}$/', $phone)) {
        $phone = '+263' . substr($phone, 1);
    }
    try {
        // Generate 6-digit OTP
        $otp = sprintf('%06d', mt_rand(1, 999999));
        // Store OTP in DB (or Redis for production) with expiry
        $stmt = $pdo->prepare("INSERT INTO otps (phone, otp, expires_at) VALUES (?, ?, DATE_ADD(NOW(), INTERVAL 5 MINUTE)) ON DUPLICATE KEY UPDATE otp = ?, expires_at = DATE_ADD(NOW(), INTERVAL 5 MINUTE)");
        $stmt->execute([$phone, $otp, $otp]);
        
        // Send SMS - Placeholder; log for now
        error_log("OTP for $phone: $otp (implement SMS send here)"); // Server log
        
        // DEV FIX: Expose OTP in response for Flutter terminal (remove in prod)
        $response = ['message' => 'OTP sent to phone', 'dev_otp' => $otp];
        sendJson($response);
    } catch (PDOException $e) {
        // More specific logging
        $errorMsg = "Send OTP PDO error for $phone: " . $e->getMessage();
        error_log($errorMsg);
        sendJson(['error' => 'Database error: ' . $e->getCode() . ' - Check server logs'], 500);
    } catch (Exception $e) {
        $errorMsg = "Send OTP general error for $phone: " . $e->getMessage();
        error_log($errorMsg);
        sendJson(['error' => 'Failed to send OTP: ' . $e->getMessage()], 500);
    }
}
// Verify OTP
function verifyOTP($data) {
    global $pdo;
    $phone = $data['phone'] ?? '';
    $otp = $data['otp'] ?? '';
    if (empty($phone) || empty($otp)) {
        sendJson(['error' => 'Missing phone or OTP'], 400);
    }
    try {
        $stmt = $pdo->prepare("SELECT * FROM otps WHERE phone = ? AND otp = ? AND expires_at > NOW()");
        $stmt->execute([$phone, $otp]);
        if ($stmt->fetch()) {
            // Delete used OTP
            $delStmt = $pdo->prepare("DELETE FROM otps WHERE phone = ?");
            $delStmt->execute([$phone]);
            sendJson(['verified' => true, 'message' => 'OTP verified']);
        } else {
            sendJson(['error' => 'Invalid or expired OTP'], 400);
        }
    } catch (PDOException $e) {
        error_log("Verify OTP error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Handle Google Login (requires google/apiclient in PHP - install via composer)
function handleGoogleLogin($data) {
    global $pdo;
    $idToken = $data['id_token'] ?? '';
    if (empty($idToken)) {
        sendJson(['error' => 'Missing ID token'], 400);
    }

    try {
        // Mock payload processing if Composer isn't available:
        // You should have the actual Google verification logic here.
        $payload = [
            'sub' => 'mock_google_id_123',
            'email' => 'mock@example.com',
            'name' => 'Mock User',
            'email_verified' => true
        ]; 
        
        if ($payload === null || !isset($payload['sub'])) {
            sendJson(['error' => 'Invalid ID token'], 401);
        }

        $googleId = $payload['sub']; 
        $email = $payload['email'] ?? '';
        $name = $payload['name'] ?? '';
        $emailVerified = $payload['email_verified'] ?? false;

        if (!$emailVerified) {
            sendJson(['error' => 'Email not verified by Google'], 401);
        }

        // Find existing user by Google ID
        $checkStmt = $pdo->prepare("SELECT id, user_type FROM users WHERE google_id = ?");
        $checkStmt->execute([$googleId]);
        $user = $checkStmt->fetch(PDO::FETCH_ASSOC);

        if ($user) {
            // Existing user: log in
            $userId = intval($user['id']);
            $userType = $user['user_type'];
        } else {
            // New user: create account (default to 'customer')
            // NOTE: Assumes 'email' and 'google_id' columns exist in users table
            $insertStmt = $pdo->prepare("INSERT INTO users (name, email, google_id, user_type) VALUES (?, ?, ?, 'customer')");
            $insertStmt->execute([$name, $email, $googleId]);
            $userId = intval($pdo->lastInsertId());
            $userType = 'customer';
        }

        // Create session
        $sessionId = createSessionForUser($userId, $userType);

        sendJson([
            'session_id' => $sessionId,
            'user_id' => $userId,
            'user_type' => $userType,
            'message' => $user ? 'Google login successful' : 'Google account created and logged in'
        ]);

    } catch (Exception $e) {
        error_log("Google login error: " . $e->getMessage());
        sendJson(['error' => 'Google verification failed'], 500);
    }
}

// Admin Login (demo with hardcoded credentials: username 'admin', password 'password')
function adminLogin() {
    // Handle both form data and JSON
    $username = $_POST['username'] ?? '';
    $password = $_POST['password'] ?? '';
    
    // If no POST data, try JSON
    if (empty($username) || empty($password)) {
        $input = json_decode(file_get_contents('php://input'), true);
        $username = $input['username'] ?? '';
        $password = $input['password'] ?? '';
    }
    if (empty($username) || empty($password)) {
        sendJson(['error' => 'Missing credentials'], 400);
    }
    // Demo hardcoded credentials (change in production)
    if ($username === 'admin' && $password === 'password') {
        startSessionFromHeader();
        session_regenerate_id(true);
        $_SESSION['user_id'] = 0; // Dummy ID for admin
        $_SESSION['user_type'] = 'admin';
        $sessionId = session_id();
        sendJson(['success' => true, 'session_id' => $sessionId]);
    } else {
        sendJson(['error' => 'Invalid credentials'], 401);
    }
}

// Admin: Get all rider applications (fixed to handle errors properly)
function getAllRiderApplications() {
    global $pdo;
    if (!isAdmin()) {
        sendJson(['error' => 'Admin access required'], 403);
    }
    
    try {
        $sql = "
            SELECT
                rk.id AS id,
                rk.custom_rider_id AS rider_code,
                u.name,
                u.phone,
                rk.vehicle_type,
                rk.vehicle_registration AS vehicle_registration,
                rk.id_number,
                rk.status,
                rk.applied_at
            FROM rider_applications rk
            JOIN users u ON rk.rider_id = u.id
            ORDER BY rk.applied_at DESC
        ";
        
        $stmt = $pdo->prepare($sql);
        $stmt->execute();
        $riders = $stmt->fetchAll(PDO::FETCH_ASSOC);
        sendJson(['riders' => $riders]);
        
    } catch (PDOException $e) {
        error_log("Get all rider applications error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    } catch (Exception $e) {
        error_log("Get all rider applications general error: " . $e->getMessage());
        sendJson(['error' => 'Server error occurred'], 500);
    }
}

// Admin: Get all customer applications (NEW FUNCTION)
function getAllCustomerApplications() {
    global $pdo;
    if (!isAdmin()) {
        sendJson(['error' => 'Admin access required'], 403);
    }
    
    try {
        // Select all customers who have uploaded at least one picture
        $sql = "
            SELECT
                id,
                name,
                phone,
                face_picture,
                id_front_picture,
                created_at
            FROM users
            WHERE user_type = 'customer' AND (face_picture IS NOT NULL OR id_front_picture IS NOT NULL)
            ORDER BY created_at DESC
        ";
        
        $stmt = $pdo->prepare($sql);
        $stmt->execute();
        $customers = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // Convert relative paths to absolute URLs for display in the HTML
        foreach ($customers as &$customer) {
            $customer['face_picture_url'] = $customer['face_picture'] ? BASE_URL . $customer['face_picture'] : null;
            $customer['id_front_picture_url'] = $customer['id_front_picture'] ? BASE_URL . $customer['id_front_picture'] : null;
            unset($customer['face_picture']);
            unset($customer['id_front_picture']);
        }
        
        sendJson(['customers' => $customers]);
        
    } catch (PDOException $e) {
        error_log("Get all customer applications error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    } catch (Exception $e) {
        error_log("Get all customer applications general error: " . $e->getMessage());
        sendJson(['error' => 'Server error occurred'], 500);
    }
}

// Approve rider (fixed parameter)
function approveRider($riderId, $input = []) {
    global $pdo;
    if (!isAdmin()) {
        sendJson(['error' => 'Admin access required'], 403);
    }

    $riderId = intval($riderId);
    if ($riderId <= 0) sendJson(['error' => 'Invalid rider ID'], 400);

    try {
        $pdo->beginTransaction();

        // Update application status
        $upd = $pdo->prepare("UPDATE rider_applications SET status = 'approved', updated_at = NOW() WHERE rider_id = ? AND status = 'pending'");
        $upd->execute([$riderId]);

        if ($upd->rowCount() === 0) {
            $pdo->rollBack();
            sendJson(['error' => 'No pending application found'], 404);
        }

        // Update user to rider
        $pdo->prepare("UPDATE users SET user_type = 'rider' WHERE id = ?")->execute([$riderId]);

        // Create rider profile
        $kyc = $pdo->query("SELECT custom_rider_id FROM rider_applications WHERE rider_id = $riderId")->fetch();
        $riderCode = $kyc['custom_rider_id'];

        $pdo->prepare("
            INSERT INTO riders (user_id, rider_code, rating, wallet_balance) 
            VALUES (?, ?, 5.00, 0.00)
            ON DUPLICATE KEY UPDATE rider_code = ?
        ")->execute([$riderId, $riderCode, $riderCode]);

        $pdo->commit();
        sendJson(['message' => 'Rider approved and activated successfully']);
    } catch (Exception $e) {
        $pdo->rollBack();
        error_log("Approve rider error: " . $e->getMessage());
        sendJson(['error' => 'Approval failed'], 500);
    }
}

// Reject rider (fixed parameter)
function rejectRider($riderId, $input = []) {
    global $pdo;
    if (!isAdmin()) {
        sendJson(['error' => 'Admin access required'], 403);
    }
    
    // Convert riderId to integer
    $riderId = intval($riderId);
    if ($riderId <= 0) {
        sendJson(['error' => 'Invalid rider ID'], 400);
    }
    
    $reason = $input['reason'] ?? '';
    if ($reason) {
        error_log("Rider $riderId rejected: $reason");
    }
    
    try {
        $updateStmt = $pdo->prepare("UPDATE rider_applications SET status = 'rejected' WHERE rider_id = ? AND status = 'pending'");
        $updateStmt->execute([$riderId]);
        if ($updateStmt->rowCount() > 0) {
            // Optionally revert user_type to 'customer'
            $revertStmt = $pdo->prepare("UPDATE users SET user_type = 'customer' WHERE id = ?");
            $revertStmt->execute([$riderId]);
            sendJson(['message' => 'Rider application rejected']);
        } else {
            sendJson(['error' => 'No pending application found'], 404);
        }
    } catch (PDOException $e) {
        error_log("Reject rider error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Create request (customer only)
function createRequest($data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'customer') {
        sendJson(['error' => 'Unauthorized'], 403);
    }

    $pickupLat = $data['pickup_lat'] ?? 0;
    $pickupLng = $data['pickup_lng'] ?? 0;
    $dropoffLat = $data['dropoff_lat'] ?? 0;
    $dropoffLng = $data['dropoff_lng'] ?? 0;
    $parcelSize = $data['parcel_size'] ?? '';
    $suggestedFare = $data['suggested_fare'] ?? 0;
    $paymentMethod = $data['payment_method'] ?? '';
    $parcelPhotoPath = null;

    // File upload handled by multipart/form-data clients (not JSON)
    if (isset($_FILES['parcel_photo']) && $_FILES['parcel_photo']['error'] === UPLOAD_ERR_OK) {
        $uploadDir = __DIR__ . '/uploads/parcels/';
        if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);
        $fileName = uniqid() . '_' . basename($_FILES['parcel_photo']['name']);
        $filePath = $uploadDir . $fileName;
        if (move_uploaded_file($_FILES['parcel_photo']['tmp_name'], $filePath)) {
            // return relative path
            $parcelPhotoPath = 'uploads/parcels/' . $fileName;
        }
    }

    if (empty($parcelSize) || empty($paymentMethod) || $pickupLat == 0 || $pickupLng == 0 || $dropoffLat == 0 || $dropoffLng == 0) {
        sendJson(['error' => 'Missing fields'], 400);
    }

    try {
        $stmt = $pdo->prepare("INSERT INTO delivery_orders (customer_id, pickup_lat, pickup_lng, dropoff_lat, dropoff_lng, parcel_size, suggested_fare, payment_method, parcel_photo, status, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'open', NOW())");
        $stmt->execute([$user->id, $pickupLat, $pickupLng, $dropoffLat, $dropoffLng, $parcelSize, $suggestedFare, $paymentMethod, $parcelPhotoPath]);
        $requestId = intval($pdo->lastInsertId());
        sendJson(['request_id' => $requestId, 'message' => 'Request created successfully']);
    } catch (PDOException $e) {
        error_log("Create request error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Get customer's requests
function getRequests($data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'customer') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    try {
        $stmt = $pdo->prepare("SELECT id, pickup_lat, pickup_lng, dropoff_lat, dropoff_lng, parcel_size, suggested_fare, payment_method, status, created_at FROM delivery_orders WHERE customer_id = ? ORDER BY created_at DESC");
        $stmt->execute([$user->id]);
        $requests = $stmt->fetchAll(PDO::FETCH_ASSOC);
        sendJson(['requests' => $requests]);
    } catch (PDOException $e) {
        error_log("Get requests error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Get nearby requests for riders (uses HAVERSINE and HAVING)
function getNearbyRequests($data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'rider') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    $lat = floatval($data['lat'] ?? 0);
    $lng = floatval($data['lng'] ?? 0);
    $radius = floatval($data['radius'] ?? 10); // km
    if ($lat == 0 || $lng == 0) {
        sendJson(['error' => 'Missing location'], 400);
    }

    try {
        // Haversine formula in SQL; use HAVING to filter by computed distance
        $sql = "
            SELECT id, customer_id, pickup_lat, pickup_lng, dropoff_lat, dropoff_lng, parcel_size, suggested_fare, payment_method, status, created_at,
                (6371 * acos(
                    cos(radians(:lat)) * cos(radians(pickup_lat)) *
                    cos(radians(pickup_lng) - radians(:lng)) +
                    sin(radians(:lat)) * sin(radians(pickup_lat))
                )) AS distance
            FROM delivery_orders
            WHERE status = 'open'
            HAVING distance < :radius
            ORDER BY distance ASC
            LIMIT 100
        ";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([':lat' => $lat, ':lng' => $lng, ':radius' => $radius]);
        $requests = $stmt->fetchAll(PDO::FETCH_ASSOC);
        sendJson(['requests' => $requests]);
    } catch (PDOException $e) {
        error_log("Get nearby requests error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Create offer (rider only)
function createOffer($requestId, $data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'rider') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    $fare = floatval($data['fare'] ?? 0);
    $etaMins = intval($data['eta_mins'] ?? 5);

    if ($fare <= 0 || $requestId <= 0) {
        sendJson(['error' => 'Missing or invalid fare/request id'], 400);
    }

    try {
        $checkStmt = $pdo->prepare("SELECT id FROM delivery_orders WHERE id = ? AND status = 'open'");
        $checkStmt->execute([$requestId]);
        if (!$checkStmt->fetch()) {
            sendJson(['error' => 'Request not found or not open'], 404);
        }
        $stmt = $pdo->prepare("INSERT INTO offers (request_id, rider_id, fare, eta_mins, status, created_at) VALUES (?, ?, ?, ?, 'pending', NOW())");
        $stmt->execute([$requestId, $user->id, $fare, $etaMins]);
        $offerId = intval($pdo->lastInsertId());
        sendJson(['offer_id' => $offerId, 'message' => 'Offer submitted']);
    } catch (PDOException $e) {
        error_log("Create offer error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Get offers for a specific request (customer only)
function getOffersForRequest($requestId) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'customer') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    try {
        $checkStmt = $pdo->prepare("SELECT id FROM delivery_orders WHERE id = ? AND customer_id = ?");
        $checkStmt->execute([$requestId, $user->id]);
        if (!$checkStmt->fetch()) {
            sendJson(['error' => 'Request not found'], 404);
        }
        $stmt = $pdo->prepare("
            SELECT o.id, o.fare, o.eta_mins, o.created_at,
                    TIMESTAMPDIFF(SECOND, o.created_at, NOW()) as time_elapsed,
                    u.name as rider_name, u.rating, o.status
            FROM offers o
            JOIN users u ON o.rider_id = u.id
            WHERE o.request_id = ?
            ORDER BY o.created_at DESC
        ");
        $stmt->execute([$requestId]);
        $offers = $stmt->fetchAll(PDO::FETCH_ASSOC);
        foreach ($offers as &$offer) {
            $offer['time_left'] = max(0, 60 - intval($offer['time_elapsed']));
        }
        sendJson(['offers' => $offers]);
    } catch (PDOException $e) {
        error_log("Get offers error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Accept offer (customer only)
function acceptOffer($offerId, $data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'customer') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    try {
        $offerStmt = $pdo->prepare("SELECT o.request_id, o.rider_id, o.fare, dr.customer_id FROM offers o JOIN delivery_orders dr ON o.request_id = dr.id WHERE o.id = ? AND o.status = 'pending'");
        $offerStmt->execute([$offerId]);
        $offer = $offerStmt->fetch(PDO::FETCH_ASSOC);
        if (!$offer || intval($offer['customer_id']) !== $user->id) {
            sendJson(['error' => 'Offer not found or not accessible'], 404);
        }

        $pdo->beginTransaction();
        try {
            $deliveryStmt = $pdo->prepare("INSERT INTO deliveries (request_id, rider_id, customer_id, fare, status, created_at) VALUES (?, ?, ?, ?, 'assigned', NOW())");
            $deliveryStmt->execute([$offer['request_id'], $offer['rider_id'], $user->id, $offer['fare']]);
            $deliveryId = intval($pdo->lastInsertId());

            $updateReqStmt = $pdo->prepare("UPDATE delivery_orders SET status = 'assigned' WHERE id = ?");
            $updateReqStmt->execute([$offer['request_id']]);

            $updateOfferStmt = $pdo->prepare("UPDATE offers SET status = 'accepted' WHERE id = ?");
            $updateOfferStmt->execute([$offerId]);

            $rejectStmt = $pdo->prepare("UPDATE offers SET status = 'rejected' WHERE request_id = ? AND id != ?");
            $rejectStmt->execute([$offer['request_id'], $offerId]);

            $pdo->commit();
            sendJson(['delivery_id' => $deliveryId, 'message' => 'Offer accepted, delivery assigned']);
        } catch (PDOException $e) {
            $pdo->rollBack();
            throw $e;
        }
    } catch (PDOException $e) {
        error_log("Accept offer error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Update delivery status (rider only)
function updateDeliveryStatus($deliveryId, $data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'rider') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    $status = $data['status'] ?? '';
    if (empty($status) || $deliveryId <= 0) {
        sendJson(['error' => 'Missing fields'], 400);
    }
    try {
        $checkStmt = $pdo->prepare("SELECT id FROM deliveries WHERE id = ? AND rider_id = ?");
        $checkStmt->execute([$deliveryId, $user->id]);
        if (!$checkStmt->fetch()) {
            sendJson(['error' => 'Delivery not found'], 404);
        }
        $stmt = $pdo->prepare("UPDATE deliveries SET status = ?, updated_at = NOW() WHERE id = ?");
        $stmt->execute([$status, $deliveryId]);
        if ($status === 'delivered') {
            $updateReqStmt = $pdo->prepare("UPDATE delivery_orders SET status = 'delivered' WHERE id = (SELECT request_id FROM deliveries WHERE id = ?)");
            $updateReqStmt->execute([$deliveryId]);
        }
        sendJson(['message' => 'Status updated']);
    } catch (PDOException $e) {
        error_log("Update status error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Upload POD photo (rider only)
function uploadPod($deliveryId, $file, $data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'rider') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    if (!$file || $file['error'] !== UPLOAD_ERR_OK) {
        sendJson(['error' => 'No photo uploaded'], 400);
    }
    try {
        $checkStmt = $pdo->prepare("SELECT id FROM deliveries WHERE id = ? AND rider_id = ? AND status = 'delivered'");
        $checkStmt->execute([$deliveryId, $user->id]);
        if (!$checkStmt->fetch()) {
            sendJson(['error' => 'Delivery not ready for POD or not found'], 400);
        }
        $uploadDir = __DIR__ . '/uploads/pod/';
        if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);
        $fileName = uniqid() . '_' . basename($file['name']);
        $filePath = $uploadDir . $fileName;
        if (move_uploaded_file($file['tmp_name'], $filePath)) {
            $relativePath = 'uploads/pod/' . $fileName;
            $stmt = $pdo->prepare("UPDATE deliveries SET pod_photo = ?, pod_uploaded_at = NOW() WHERE id = ?");
            $stmt->execute([$relativePath, $deliveryId]);
            sendJson(['message' => 'POD uploaded successfully']);
        } else {
            sendJson(['error' => 'Upload failed'], 500);
        }
    } catch (PDOException $e) {
        error_log("Upload POD error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Update rider location
function updateLocation($data) {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'rider') {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    $lat = $data['lat'] ?? 0;
    $lng = $data['lng'] ?? 0;
    if (empty($lat) || empty($lng)) {
        sendJson(['error' => 'Missing location'], 400);
    }
    try {
        $stmt = $pdo->prepare("INSERT INTO rider_locations (rider_id, lat, lng, updated_at) VALUES (?, ?, ?, NOW()) ON DUPLICATE KEY UPDATE lat = ?, lng = ?, updated_at = NOW()");
        $stmt->execute([$user->id, $lat, $lng, $lat, $lng]);
        sendJson(['message' => 'Location updated']);
    } catch (PDOException $e) {
        error_log("Update location error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Track delivery (customer or rider)
function trackDelivery($deliveryId) {
    global $pdo;
    $user = validateSession();
    if (!$user) {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    try {
        $checkStmt = $pdo->prepare("
            SELECT d.status, d.fare, d.request_id, dr.pickup_lat, dr.pickup_lng, dr.dropoff_lat, dr.dropoff_lng,
                    rl.lat as rider_lat, rl.lng as rider_lng, u.name as rider_name
            FROM deliveries d
            JOIN delivery_orders dr ON d.request_id = dr.id
            LEFT JOIN rider_locations rl ON d.rider_id = rl.rider_id
            JOIN users u ON d.rider_id = u.id
            WHERE d.id = ? AND (d.customer_id = ? OR d.rider_id = ?)
        ");
        $checkStmt->execute([$deliveryId, $user->id, $user->id]);
        $delivery = $checkStmt->fetch(PDO::FETCH_ASSOC);
        if (!$delivery) {
            sendJson(['error' => 'Delivery not found'], 404);
        }
        if (!empty($delivery['rider_lat']) && !empty($delivery['rider_lng'])) {
            $distance = haversineDistance($delivery['rider_lat'], $delivery['rider_lng'], $delivery['dropoff_lat'], $delivery['dropoff_lng']);
            // Assume ~30 km/h => 0.5 km/min; adjust as needed
            $delivery['eta_mins'] = max(1, round($distance / 0.5));
        } else {
            $delivery['eta_mins'] = 5;
        }
        sendJson(['delivery' => $delivery]);
    } catch (PDOException $e) {
        error_log("Track delivery error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

// Haversine helper
function haversineDistance($lat1, $lon1, $lat2, $lon2) {
    $R = 6371;
    $dLat = deg2rad($lat2 - $lat1);
    $dLon = deg2rad($lon2 - $lon1);
    $a = sin($dLat/2) * sin($dLat/2) + cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * sin($dLon/2) * sin($dLon/2);
    $c = 2 * atan2(sqrt($a), sqrt(1-$a));
    return $R * $c;
}

// --- NEW FUNCTIONS FOR RIDER APPLICATION ---
function getRiderApplicationStatus() {
    global $pdo;
    $user = validateSession();
    if (!$user) {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    try {
        $stmt = $pdo->prepare("SELECT rk.id, rk.status, rk.custom_rider_id AS rider_code, rk.applied_at FROM rider_applications rk WHERE rk.rider_id = ?");
        $stmt->execute([$user->id]);
        $application = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($application) {
            sendJson([
                'status' => $application['status'] ?? 'pending',  // Default if no status column
                'rider_id' => $application['rider_code'],
                'applied_at' => $application['applied_at'],
                'message' => ($application['status'] ?? 'pending') == 'pending' ? 'Application under review' : 'Application ' . ($application['status'] ?? 'pending')
            ]);
        } else {
            sendJson(['status' => 'not_applied']);
        }
    } catch (PDOException $e) {
        error_log("Get rider status error: " . $e->getMessage());
        sendJson(['error' => 'Database error occurred'], 500);
    }
}

function uploadImage() {
    global $pdo;
    $user = validateSession();
    if (!$user) {
        sendJson(['error' => 'Unauthorized'], 403);
    }
    
    if (!isset($_FILES['image']) || $_FILES['image']['error'] !== UPLOAD_ERR_OK) {
        sendJson(['error' => 'No image uploaded'], 400);
    }
    
    $uploadDir = __DIR__ . '/uploads/rider_docs/';
    if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);
    
    $fileName = uniqid() . '_' . basename($_FILES['image']['name']);
    $filePath = $uploadDir . $fileName;
    
    if (move_uploaded_file($_FILES['image']['tmp_name'], $filePath)) {
        $relativePath = 'uploads/rider_docs/' . $fileName;
        sendJson(['image_path' => $relativePath, 'message' => 'Image uploaded successfully']);
    } else {
        sendJson(['error' => 'Upload failed'], 500);
    }
}
function applyForRiderMultipart() {
    global $pdo;
    $user = validateSession();
    if (!$user || $user->user_type !== 'customer') {
        sendJson(['error' => 'Only customers can apply to be riders'], 403);
    }

    $userId = $user->id;

    // Check if already applied
    $check = $pdo->prepare("SELECT id FROM rider_applications WHERE rider_id = ?");
    $check->execute([$userId]);
    if ($check->fetch()) {
        sendJson(['error' => 'You have already applied to be a rider'], 409);
    }

    // Required fields
    $fullName = trim($_POST['full_name'] ?? '');
    $idNumber = trim($_POST['id_number'] ?? '');
    $vehicleRegistration = trim($_POST['vehicle_registration'] ?? '');

    if (empty($fullName) || empty($idNumber) || empty($vehicleRegistration)) {
        sendJson(['error' => 'Required fields missing'], 400);
    }

    // Generate unique rider code
    $riderCode = strtoupper(substr(preg_replace('/[^A-Z0-9]/i', '', $fullName), 0, 6)) . rand(100, 999);
    $customRiderId = "RIDER" . $riderCode;

    $uploadDir = __DIR__ . '/uploads/rider_applications/';
    if (!is_dir($uploadDir)) mkdir($uploadDir, 0755, true);

    $idFront = uploadFile($_FILES['id_front_image'] ?? null, $uploadDir, 'id_front');
    $idBack = uploadFile($_FILES['id_back_image'] ?? null, $uploadDir, 'id_back');
    $vehFront = uploadFile($_FILES['vehicle_front_image'] ?? null, $uploadDir, 'veh_front');
    $vehBack = uploadFile($_FILES['vehicle_back_image'] ?? null, $uploadDir, 'veh_back');
    $license = uploadFile($_FILES['license_image'] ?? null, $uploadDir, 'license');

    try {
        $pdo->beginTransaction();

        $stmt = $pdo->prepare("
            INSERT INTO rider_applications 
            (rider_id, custom_rider_id, full_name, id_number, address, emergency_contact,
             vehicle_type, vehicle_model, vehicle_year, vehicle_registration, license_number,
             id_front_image, id_back_image, vehicle_front_image, vehicle_back_image, license_image)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ");
        $stmt->execute([
            $userId, $customRiderId, $fullName, $idNumber,
            $_POST['address'] ?? '', $_POST['emergency_contact'] ?? '',
            $_POST['vehicle_type'] ?? '', $_POST['vehicle_model'] ?? '', $_POST['vehicle_year'] ?? '',
            $vehicleRegistration, $_POST['license_number'] ?? '',
            $idFront, $idBack, $vehFront, $vehBack, $license
        ]);

        // Update user to pending_rider
        $pdo->prepare("UPDATE users SET user_type = 'pending_rider' WHERE id = ?")->execute([$userId]);

        $pdo->commit();

        sendJson([
            'message' => 'Application submitted! Awaiting approval.',
            'rider_code' => $customRiderId,
            'status' => 'pending'
        ]);
    } catch (Exception $e) {
        $pdo->rollBack();
        error_log("Apply rider error: " . $e->getMessage());
        sendJson(['error' => 'Failed to submit application'], 500);
    }
}
?>"

and my users "	#	Name	Type	Collation	Attributes	Null	Default	Comments	Extra	Action
	1	id Primary	int(11)			No	None		AUTO_INCREMENT	Change Change	Drop Drop	
	2	name	varchar(150)	utf8mb4_unicode_ci		No	None			Change Change	Drop Drop	
	3	phone Index	varchar(30)	utf8mb4_unicode_ci		No	None			Change Change	Drop Drop	
	4	password_hash	varchar(255)	utf8mb4_unicode_ci		No	None			Change Change	Drop Drop	
	5	face_picture	varchar(255)	utf8mb4_unicode_ci		Yes	NULL			Change Change	Drop Drop	
	6	id_front_picture	varchar(255)	utf8mb4_unicode_ci		Yes	NULL			Change Change	Drop Drop	
	7	user_type Index	enum('customer', 'rider', 'admin', 'pending_rider'...	utf8mb4_unicode_ci		No	customer			Change Change	Drop Drop	
	8	created_at	timestamp			Yes	current_timestamp()			Change Change	Drop Drop	
With selected:  Check all With selected:        
 Propose table structure Propose table structure Documentation Move columns Move columns Normalize Normalize
Add column  Add 
1
 column(s)   
after created_at
 
Indexes Documentation
Action	Keyname	Type	Unique	Packed	Column	Cardinality	Collation	Null	Comment
Edit Edit	Rename Rename	Drop Drop	PRIMARY	BTREE	Yes	No	id	32	A	No	
Edit Edit	Rename Rename	Drop Drop	idx_phone	BTREE	No	No	phone	32	A	No	
Edit Edit	Rename Rename	Drop Drop	idx_user_type	BTREE	No	No	user_type	4	A	No	
Create an index on 
1
 columns 
Partitions Documentation
 No partitioning defined!

Information
Space usage
Data	16.0	KiB
Index	32.0	KiB
Overhead	0	B
Effective	48.0	KiB
Total	48.0	KiB
Optimize table Optimize table
Row statistics
Format	dynamic
Collation	utf8mb4_unicode_ci
Next autoindex	53
Creation	Nov 22, 2025 at 11:40 PM
Last update	Nov 24, 2025 at 11:35 PM
Last check	Nov 27, 2025 at 08:33 AM
"

..rider_applications

"Table structure Table structure
Relation view Relation view
#	Name	Type	Collation	Attributes	Null	Default	Comments	Extra	Action
	1	id Primary	int(11)			No	None		AUTO_INCREMENT	Change Change	Drop Drop	
	2	rider_id Index	int(11)			No	None			Change Change	Drop Drop	
	3	custom_rider_id Index	varchar(100)	utf8mb4_general_ci		No	None			Change Change	Drop Drop	
	4	full_name	varchar(255)	utf8mb4_general_ci		No	None			Change Change	Drop Drop	
	5	id_number	varchar(50)	utf8mb4_general_ci		No	None			Change Change	Drop Drop	
	6	address	text	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	7	emergency_contact	varchar(20)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	8	vehicle_type	varchar(100)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	9	vehicle_model	varchar(100)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	10	vehicle_year	varchar(4)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	11	vehicle_registration	varchar(50)	utf8mb4_general_ci		No	None			Change Change	Drop Drop	
	12	license_number	varchar(50)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	13	id_front_image	varchar(500)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	14	id_back_image	varchar(500)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	15	vehicle_front_image	varchar(500)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	16	vehicle_back_image	varchar(500)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	17	license_image	varchar(500)	utf8mb4_general_ci		Yes	NULL			Change Change	Drop Drop	
	18	status Index	enum('pending', 'approved', 'rejected')	utf8mb4_general_ci		Yes	pending			Change Change	Drop Drop	
	19	applied_at	timestamp			Yes	current_timestamp()			Change Change	Drop Drop	
	20	updated_at	timestamp			Yes	current_timestamp()		ON UPDATE CURRENT_TIMESTAMP()	Change Change	Drop Drop	
With selected:  Check all With selected:        
 Propose table structure Propose table structure Documentation Move columns Move columns Normalize Normalize
Add column  Add 
1
 column(s)   
after updated_at
 
Indexes Documentation
Action	Keyname	Type	Unique	Packed	Column	Cardinality	Collation	Null	Comment
Edit Edit	Rename Rename	Drop Drop	PRIMARY	BTREE	Yes	No	id	19	A	No	
Edit Edit	Rename Rename	Drop Drop	rider_id	BTREE	Yes	No	rider_id	19	A	No	
Edit Edit	Rename Rename	Drop Drop	custom_rider_id	BTREE	Yes	No	custom_rider_id	19	A	No	
Edit Edit	Rename Rename	Drop Drop	idx_status	BTREE	No	No	status	2	A	Yes	
Edit Edit	Rename Rename	Drop Drop	idx_rider_id	BTREE	No	No	rider_id	19	A	No	
Create an index on 
1
 columns 
Partitions Documentation
 No partitioning defined!

Information
Space usage
Data	16.0	KiB
Index	64.0	KiB
Overhead	0	B
Effective	80.0	KiB
Total	80.0	KiB
Optimize table Optimize table
Row statistics
Format	dynamic
Collation	utf8mb4_general_ci
Next autoindex	43
Creation	Nov 22, 2025 at 03:40 PM
Last update	Nov 24, 2025 at 10:41 PM
Last check	Nov 27, 2025 at 08:34 AM
"

.. riders
"Table structure Table structure
Relation view Relation view
#	Name	Type	Collation	Attributes	Null	Default	Comments	Extra	Action
	1	id Primary	int(11)			No	None		AUTO_INCREMENT	Change Change	Drop Drop	
	2	user_id Index	int(11)			No	None			Change Change	Drop Drop	
	3	rider_code Index	varchar(50)	utf8mb4_general_ci		No	None			Change Change	Drop Drop	
	4	rating	decimal(3,2)			Yes	5.00			Change Change	Drop Drop	
	5	total_trips	int(11)			Yes	0			Change Change	Drop Drop	
	6	total_earnings	decimal(10,2)			Yes	0.00			Change Change	Drop Drop	
	7	wallet_balance	decimal(10,2)			Yes	0.00			Change Change	Drop Drop	
	8	is_online Index	tinyint(1)			Yes	0			Change Change	Drop Drop	
	9	current_lat	double			Yes	NULL			Change Change	Drop Drop	
	10	current_lng	double			Yes	NULL			Change Change	Drop Drop	
	11	last_active_at	timestamp			Yes	NULL			Change Change	Drop Drop	
	12	created_at	timestamp			Yes	current_timestamp()			Change Change	Drop Drop	
	13	updated_at	timestamp			Yes	current_timestamp()		ON UPDATE CURRENT_TIMESTAMP()	Change Change	Drop Drop	
With selected:  Check all With selected:        
 Propose table structure Propose table structure Documentation Move columns Move columns Normalize Normalize
Add column  Add 
1
 column(s)   
after updated_at
 
Indexes Documentation
Action	Keyname	Type	Unique	Packed	Column	Cardinality	Collation	Null	Comment
Edit Edit	Rename Rename	Drop Drop	PRIMARY	BTREE	Yes	No	id	0	A	No	
Edit Edit	Rename Rename	Drop Drop	user_id	BTREE	Yes	No	user_id	0	A	No	
Edit Edit	Rename Rename	Drop Drop	rider_code	BTREE	Yes	No	rider_code	0	A	No	
Edit Edit	Rename Rename	Drop Drop	idx_online	BTREE	No	No	is_online	0	A	Yes	
Edit Edit	Rename Rename	Drop Drop	idx_rider_code	BTREE	No	No	rider_code	0	A	No	
Create an index on 
1
 columns 
Partitions Documentation
 No partitioning defined!

Information
Space usage
Data	16.0	KiB
Index	64.0	KiB
Overhead	0	B
Effective	80.0	KiB
Total	80.0	KiB
Optimize table Optimize table
Row statistics
Format	dynamic
Collation	utf8mb4_general_ci
Next autoindex	1
Creation	Nov 22, 2025 at 03:40 PM
Last update	Nov 27, 2025 at 08:34 AM
Last check	Nov 27, 2025 at 08:34 AM
"

 and my 

signup_screen
"// lib/screens/signup_screen.dart
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import 'package:country_code_picker/country_code_picker.dart';
import 'dart:convert';
import 'dart:io'; // Import for File
import 'package:image_picker/image_picker.dart'; // Import for image picking
import 'login.dart';
import '../screens/customer/customer_home_screen.dart';
import '../services/notification_service.dart';

// BASE_URL for API calls
const String _baseUrl = 'https://chareta.com/riderhub/api/api.php';

class SignupScreen extends StatefulWidget {
  const SignupScreen({super.key});

  @override
  State<SignupScreen> createState() => _SignupScreenState();
}

class _SignupScreenState extends State<SignupScreen> {
  bool _isLoading = false;
  final GoogleSignIn _googleSignIn = GoogleSignIn(scopes: ['email', 'profile']);

  Future<void> _signInWithGoogle() async {
    setState(() => _isLoading = true);
    try {
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
      if (googleUser == null) return; // Canceled
      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;
      if (googleAuth.idToken == null) {
        throw Exception('No ID token received');
      }
      final response = await http
          .post(
            Uri.parse('$_baseUrl?action=google_login'),
            headers: {'Content-Type': 'application/json'},
            body: jsonEncode({'id_token': googleAuth.idToken}),
          )
          .timeout(const Duration(seconds: 30));
      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] == null) {
          final String sessionId = responseData['session_id'];
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('session_id', sessionId);
          await prefs.setString('user_type', responseData['user_type']);
          await prefs.setBool('isLoggedIn', true);
          await _fetchAndStoreUserProfile(sessionId);
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: const Text('Google sign-in successful!'),
                backgroundColor: Colors.green,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            );
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(
                builder: (context) => const CustomerHomeScreen(),
              ),
            );
          }
        } else {
          _showError(responseData['error']);
        }
      } else {
        _showError('Google sign-in failed: ${response.statusCode}');
      }
    } catch (e) {
      _showError('Google sign-in error: $e');
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<void> _fetchAndStoreUserProfile(String sessionId) async {
    try {
      final response = await http
          .get(
            Uri.parse('$_baseUrl?action=profile'),
            headers: {'X-Session-Id': sessionId},
          )
          .timeout(const Duration(seconds: 30));
      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] == null) {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('user_name', responseData['name'] ?? '');
          await prefs.setString('user_phone', responseData['phone'] ?? '');
          await prefs.setString('user_email', responseData['email'] ?? '');
        }
      }
    } catch (e) {
      debugPrint('Profile fetch error: $e');
    }
  }

  void _showError(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              const SizedBox(height: 40),
              Center(
                child: Container(
                  width: 80,
                  height: 80,
                  decoration: BoxDecoration(
                    gradient: const RadialGradient(
                      colors: [Color(0xFF667eea), Color(0xFF764ba2)],
                      center: Alignment.center,
                      radius: 0.8,
                    ),
                    shape: BoxShape.circle,
                  ),
                  child: ClipOval(
                    child: Image.asset(
                      'assets/logo.png',
                      fit: BoxFit.cover,
                      errorBuilder: (context, error, stackTrace) => const Icon(
                        Icons.delivery_dining_rounded,
                        size: 40,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 32),
              Text(
                'Create Your Account',
                textAlign: TextAlign.center,
                style: GoogleFonts.inter(
                  fontSize: 28,
                  fontWeight: FontWeight.bold,
                  color: Colors.black87,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                'Join Biker Delivery today',
                textAlign: TextAlign.center,
                style: GoogleFonts.inter(
                  fontSize: 16,
                  color: Colors.grey.shade600,
                ),
              ),
              const SizedBox(height: 60),
              SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton.icon(
                  onPressed: _isLoading
                      ? null
                      : () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const PhoneEntryScreen(),
                            ),
                          );
                        },
                  icon: const Icon(Icons.phone_rounded, color: Colors.white),
                  label: Text(
                    'Continue with Phone',
                    style: GoogleFonts.inter(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF667eea),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                    shadowColor: Colors.black.withOpacity(0.2),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              Row(
                children: [
                  Expanded(
                    child: Divider(color: Colors.grey.shade300, thickness: 1),
                  ),
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Text(
                      'or',
                      style: GoogleFonts.inter(
                        color: Colors.grey.shade500,
                        fontSize: 14,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                  Expanded(
                    child: Divider(color: Colors.grey.shade300, thickness: 1),
                  ),
                ],
              ),
              const SizedBox(height: 16),
              SizedBox(
                width: double.infinity,
                height: 56,
                child: OutlinedButton.icon(
                  onPressed: _isLoading ? null : _signInWithGoogle,
                  icon: Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(6),
                    ),
                    child: const Icon(
                      Icons.g_mobiledata,
                      color: Color(0xFF4285F4),
                      size: 20,
                    ),
                  ),
                  label: Text(
                    'Continue with Google',
                    style: GoogleFonts.inter(
                      fontSize: 16,
                      fontWeight: FontWeight.w500,
                      color: Colors.black87,
                    ),
                  ),
                  style: OutlinedButton.styleFrom(
                    side: const BorderSide(color: Color(0xFF667eea)),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    padding: const EdgeInsets.symmetric(vertical: 16),
                  ),
                ),
              ),
              const SizedBox(height: 40),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    "Already have an account? ",
                    style: GoogleFonts.inter(color: Colors.grey.shade600),
                  ),
                  GestureDetector(
                    onTap: _isLoading
                        ? null
                        : () => Navigator.pushReplacement(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const LoginScreen(),
                            ),
                          ),
                    child: Text(
                      'Sign In',
                      style: GoogleFonts.inter(
                        color: const Color(0xFF667eea),
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                      ),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 32),
            ],
          ),
        ),
      ),
    );
  }
}

class PhoneEntryScreen extends StatefulWidget {
  const PhoneEntryScreen({super.key});

  @override
  State<PhoneEntryScreen> createState() => _PhoneEntryScreenState();
}

class _PhoneEntryScreenState extends State<PhoneEntryScreen> {
  final TextEditingController _phoneController = TextEditingController();
  CountryCode _selectedCode = CountryCode.fromCountryCode('ZW');
  bool _isSending = false;

  @override
  void dispose() {
    _phoneController.dispose();
    super.dispose();
  }

  Future<void> _sendOtp() async {
    if (_phoneController.text.trim().isEmpty) {
      _showError('Please enter your phone number');
      return;
    }
    // Full phone number includes the country code. The API will handle prepending +263 if 07xxxxxx or 08xxxxxx is used.
    // Send only the local part, or the already-formatted one if we trust the picker/user input.
    // To match the API's expectation: send the full +CODE+NUMBER
    final String fullPhone =
        _selectedCode.dialCode! + _phoneController.text.trim();

    setState(() => _isSending = true);
    try {
      final response = await http
          .post(
            Uri.parse('$_baseUrl?action=send_otp'),
            headers: {'Content-Type': 'application/json'},
            body: jsonEncode({'phone': fullPhone}),
          )
          .timeout(const Duration(seconds: 30));
      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);

        // Print to terminal/console
        debugPrint('Full API Response: $responseData');

        // Show local notification with DEV_OTP
        if (responseData['dev_otp'] != null) {
          final String otp = responseData['dev_otp'].toString();
          await NotificationService.showOtpNotification(otp);
        }

        if (responseData['error'] != null) {
          _showError(responseData['error']);
        } else {
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: const Text(
                  'OTP sent successfully! Check your notifications.',
                ),
                backgroundColor: Colors.green,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            );
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => OtpVerifyScreen(phone: fullPhone),
              ),
            );
          }
        }
      } else {
        _showError('Failed to send OTP: HTTP ${response.statusCode}');
      }
    } catch (e) {
      _showError('Network error: $e');
    } finally {
      if (mounted) setState(() => _isSending = false);
    }
  }

  void _showError(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: Text(
          'Phone Number',
          style: GoogleFonts.inter(fontWeight: FontWeight.bold),
        ),
        backgroundColor: Colors.white,
        elevation: 0,
        foregroundColor: Colors.black87,
        centerTitle: true,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              const SizedBox(height: 20),
              Text(
                'Enter your phone number',
                style: GoogleFonts.inter(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.black87,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                "We'll send you a 6-digit verification code",
                style: GoogleFonts.inter(
                  fontSize: 16,
                  color: Colors.grey.shade600,
                ),
              ),
              const SizedBox(height: 48),
              Row(
                children: [
                  CountryCodePicker(
                    onChanged: (code) {
                      setState(() => _selectedCode = code);
                    },
                    initialSelection: 'ZW',
                    favorite: const ['+263', 'ZW'],
                    showCountryOnly: true,
                    alignLeft: false,
                    textStyle: GoogleFonts.inter(
                      fontSize: 18,
                      color: Colors.black87,
                    ),
                    padding: const EdgeInsets.symmetric(
                      horizontal: 8,
                      vertical: 4,
                    ),
                    dialogBackgroundColor: Colors.white,
                    backgroundColor: Colors.grey.shade50,
                    boxDecoration: BoxDecoration(
                      border: Border.all(color: Colors.grey.shade300),
                      color: Colors.grey.shade50,
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: TextFormField(
                      controller: _phoneController,
                      keyboardType: TextInputType.phone,
                      decoration: InputDecoration(
                        labelText: 'Phone Number',
                        labelStyle: TextStyle(color: Colors.grey.shade600),
                        filled: true,
                        fillColor: Colors.grey.shade50,
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: Colors.grey.shade300),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(color: Colors.grey.shade300),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: const BorderSide(
                            color: Color(0xFF667eea),
                            width: 2,
                          ),
                        ),
                        contentPadding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 16,
                        ),
                      ),
                      style: GoogleFonts.inter(color: Colors.black87),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 32),
              SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton(
                  onPressed: _isSending ? null : _sendOtp,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF667eea),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                    shadowColor: Colors.black.withOpacity(0.2),
                  ),
                  child: _isSending
                      ? const SizedBox(
                          height: 20,
                          width: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              Colors.white,
                            ),
                          ),
                        )
                      : Text(
                          'Send OTP',
                          style: GoogleFonts.inter(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class OtpVerifyScreen extends StatefulWidget {
  final String phone;
  const OtpVerifyScreen({super.key, required this.phone});

  @override
  State<OtpVerifyScreen> createState() => _OtpVerifyScreenState();
}

class _OtpVerifyScreenState extends State<OtpVerifyScreen> {
  final TextEditingController _otpController = TextEditingController();
  bool _isVerifying = false;

  @override
  void dispose() {
    _otpController.dispose();
    super.dispose();
  }

  Future<void> _verifyOtp() async {
    if (_otpController.text.length != 6) {
      _showError('Please enter a valid 6-digit OTP');
      return;
    }
    setState(() => _isVerifying = true);
    try {
      final response = await http
          .post(
            Uri.parse('$_baseUrl?action=verify_otp'),
            headers: {'Content-Type': 'application/json'},
            body: jsonEncode({
              'phone': widget.phone,
              'otp': _otpController.text,
            }),
          )
          .timeout(const Duration(seconds: 30));
      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] != null) {
          _showError(responseData['error']);
        } else if (responseData['verified'] == true) {
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(
                  responseData['message'] ?? 'Verification successful!',
                ),
                backgroundColor: Colors.green,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            );
            // Navigate to registration details screen after OTP verification
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) =>
                    RegisterDetailsScreen(phone: widget.phone),
              ),
            );
          }
        }
      } else {
        _showError('Verification failed');
      }
    } catch (e) {
      _showError('Network error: $e');
    } finally {
      if (mounted) setState(() => _isVerifying = false);
    }
  }

  void _showError(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: Text(
          'Verify OTP',
          style: GoogleFonts.inter(fontWeight: FontWeight.bold),
        ),
        backgroundColor: Colors.white,
        elevation: 0,
        foregroundColor: Colors.black87,
        centerTitle: true,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              const SizedBox(height: 40),
              Text(
                'Verification Code',
                style: GoogleFonts.inter(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.black87,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 8),
              Text(
                'Enter the 6-digit code sent to ${widget.phone}',
                style: GoogleFonts.inter(
                  fontSize: 16,
                  color: Colors.grey.shade600,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 48),
              TextFormField(
                controller: _otpController,
                keyboardType: TextInputType.number,
                maxLength: 6,
                textAlign: TextAlign.center,
                style: GoogleFonts.inter(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.black87,
                ),
                decoration: InputDecoration(
                  counterText: '',
                  filled: true,
                  fillColor: Colors.grey.shade50,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(color: Colors.grey.shade300),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(color: Colors.grey.shade300),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(
                      color: Color(0xFF667eea),
                      width: 2,
                    ),
                  ),
                  contentPadding: const EdgeInsets.symmetric(vertical: 20),
                ),
              ),
              const SizedBox(height: 32),
              SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton(
                  onPressed: _isVerifying ? null : _verifyOtp,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF667eea),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 4,
                    shadowColor: Colors.black.withOpacity(0.2),
                  ),
                  child: _isVerifying
                      ? const SizedBox(
                          height: 20,
                          width: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              Colors.white,
                            ),
                          ),
                        )
                      : Text(
                          'Verify',
                          style: GoogleFonts.inter(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// =================================================================
// UPDATED RegisterDetailsScreen with Image Pickers and Multipart Registration
// =================================================================

class RegisterDetailsScreen extends StatefulWidget {
  final String phone;
  const RegisterDetailsScreen({super.key, required this.phone});

  @override
  State<RegisterDetailsScreen> createState() => _RegisterDetailsScreenState();
}

class _RegisterDetailsScreenState extends State<RegisterDetailsScreen> {
  final TextEditingController _firstNameController = TextEditingController();
  final TextEditingController _lastNameController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();

  // Image files
  File? _facePicture;
  File? _idFrontPicture;

  bool _isRegistering = false;
  final ImagePicker _picker = ImagePicker();

  @override
  void dispose() {
    _firstNameController.dispose();
    _lastNameController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  // Helper to pick an image
  Future<void> _pickImage(ImageSource source, bool isFacePicture) async {
    final pickedFile = await _picker.pickImage(
      source: source,
      imageQuality: 50, // Compress image quality
    );

    if (pickedFile != null) {
      setState(() {
        if (isFacePicture) {
          _facePicture = File(pickedFile.path);
        } else {
          _idFrontPicture = File(pickedFile.path);
        }
      });
    }
  }

  // Widget to display an image picker button
  Widget _buildImagePicker({
    required String title,
    required String buttonText,
    required File? imageFile,
    required bool isFacePicture,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          title,
          style: GoogleFonts.inter(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: Colors.black87,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          height: 120,
          decoration: BoxDecoration(
            color: Colors.grey.shade50,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: Colors.grey.shade300),
          ),
          child: imageFile == null
              ? Center(
                  child: OutlinedButton.icon(
                    onPressed: _isRegistering
                        ? null
                        : () async {
                            await _pickImage(
                              ImageSource.gallery,
                              isFacePicture,
                            );
                          },
                    icon: const Icon(Icons.upload_file),
                    label: Text(buttonText),
                  ),
                )
              : Stack(
                  fit: StackFit.expand,
                  children: [
                    ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: Image.file(imageFile, fit: BoxFit.cover),
                    ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: GestureDetector(
                        onTap: () {
                          setState(() {
                            if (isFacePicture) {
                              _facePicture = null;
                            } else {
                              _idFrontPicture = null;
                            }
                          });
                        },
                        child: CircleAvatar(
                          backgroundColor: Colors.red.withOpacity(0.8),
                          radius: 14,
                          child: const Icon(
                            Icons.close,
                            size: 16,
                            color: Colors.white,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
        ),
        const SizedBox(height: 16),
      ],
    );
  }

  Future<void> _registerUser() async {
    final String firstName = _firstNameController.text.trim();
    final String lastName = _lastNameController.text.trim();
    final String password = _passwordController.text.trim();

    // Validation
    if (firstName.isEmpty || lastName.isEmpty || password.isEmpty) {
      _showError('Please fill in all text fields');
      return;
    }
    if (password.length < 6) {
      _showError('Password must be at least 6 characters');
      return;
    }
    if (_facePicture == null || _idFrontPicture == null) {
      _showError(
        'Please upload both your face picture and ID/License front picture',
      );
      return;
    }

    final String fullName = '$firstName $lastName';
    setState(() => _isRegistering = true);

    try {
      // 1. Create a Multipart Request
      var request = http.MultipartRequest(
        'POST',
        Uri.parse('$_baseUrl?action=register_multipart'), // New action
      );

      // 2. Add text fields to the request
      request.fields['name'] = fullName;
      request.fields['phone'] = widget.phone;
      request.fields['password'] = password;
      request.fields['user_type'] = 'customer';

      // 3. Add files to the request
      request.files.add(
        await http.MultipartFile.fromPath('face_picture', _facePicture!.path),
      );
      request.files.add(
        await http.MultipartFile.fromPath(
          'id_front_picture',
          _idFrontPicture!.path,
        ),
      );

      // 4. Send the request
      final streamedResponse = await request.send();
      final response = await http.Response.fromStream(streamedResponse);

      // 5. Process the response
      if (response.statusCode == 200 || response.statusCode == 201) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] == null) {
          // FIXED: Save USER_ID as session_id (this is what your apply_rider expects)
          final String userId = responseData['user_id'].toString();

          final prefs = await SharedPreferences.getInstance();
          // await prefs.setString('session_id', userId);
          // Save BOTH — real session_id AND user_id
          await prefs.setString(
            'session_id',
            responseData['session_id'],
          ); // ← REAL one
          await prefs.setInt(
            'user_id',
            responseData['user_id'],
          ); // ← numeric fallback
          // // ← NOW SAVES USER ID!
          await prefs.setString(
            'user_type',
            responseData['user_type'] ?? 'customer',
          );
          await prefs.setBool('isLoggedIn', true);

          // Still pass the real session_id (if needed) to profile fetch — safe fallback
          await _fetchAndStoreUserProfile(userId);

          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Registration successful!'),
                backgroundColor: Colors.green,
                behavior: SnackBarBehavior.floating,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.all(Radius.circular(8)),
                ),
              ),
            );
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(
                builder: (context) => const CustomerHomeScreen(),
              ),
            );
          }
        } else {
          _showError(responseData['error']);
        }
      } else {
        _showError('Registration failed: ${response.statusCode}');
      }
    } catch (e) {
      _showError('Network error: $e');
    } finally {
      if (mounted) setState(() => _isRegistering = false);
    }
  }

  Future<void> _fetchAndStoreUserProfile(String sessionId) async {
    try {
      final response = await http
          .get(
            Uri.parse('$_baseUrl?action=profile'),
            headers: {'X-Session-Id': sessionId},
          )
          .timeout(const Duration(seconds: 30));
      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] == null) {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('user_name', responseData['name'] ?? '');
          await prefs.setString('user_phone', responseData['phone'] ?? '');
          await prefs.setString('user_email', responseData['email'] ?? '');
          // You might store the image URLs here too if you need them in the app
        }
      }
    } catch (e) {
      debugPrint('Profile fetch error: $e');
    }
  }

  void _showError(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: Text(
          'Complete Registration',
          style: GoogleFonts.inter(fontWeight: FontWeight.bold),
        ),
        backgroundColor: Colors.white,
        elevation: 0,
        foregroundColor: Colors.black87,
        centerTitle: true,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                const SizedBox(height: 20),
                Text(
                  'Tell us about yourself',
                  style: GoogleFonts.inter(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: Colors.black87,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  'Your phone ${widget.phone} is verified. Please complete your profile and upload documents.',
                  style: GoogleFonts.inter(
                    fontSize: 16,
                    color: Colors.grey.shade600,
                  ),
                ),
                const SizedBox(height: 48),
                // Text Fields
                TextFormField(
                  controller: _firstNameController,
                  decoration: _buildInputDecoration('First Name'),
                  style: GoogleFonts.inter(color: Colors.black87),
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _lastNameController,
                  decoration: _buildInputDecoration('Last Name'),
                  style: GoogleFonts.inter(color: Colors.black87),
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _passwordController,
                  obscureText: true,
                  decoration: _buildInputDecoration('Password (min 6 chars)'),
                  style: GoogleFonts.inter(color: Colors.black87),
                ),
                const SizedBox(height: 32),

                // Image Pickers
                _buildImagePicker(
                  title: 'Upload Face Picture',
                  buttonText: 'Select Face Image',
                  imageFile: _facePicture,
                  isFacePicture: true,
                ),

                _buildImagePicker(
                  title: 'Upload ID/License Front Picture',
                  buttonText: 'Select ID/License Image',
                  imageFile: _idFrontPicture,
                  isFacePicture: false,
                ),

                const SizedBox(height: 32),

                // Registration Button
                SizedBox(
                  width: double.infinity,
                  height: 56,
                  child: ElevatedButton(
                    onPressed: _isRegistering ? null : _registerUser,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF667eea),
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 4,
                      shadowColor: Colors.black.withOpacity(0.2),
                    ),
                    child: _isRegistering
                        ? const SizedBox(
                            height: 20,
                            width: 20,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor: AlwaysStoppedAnimation<Color>(
                                Colors.white,
                              ),
                            ),
                          )
                        : Text(
                            'Complete Registration',
                            style: GoogleFonts.inter(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                  ),
                ),
                const SizedBox(height: 32),
              ],
            ),
          ),
        ),
      ),
    );
  }

  // Helper for input decoration
  InputDecoration _buildInputDecoration(String label) {
    return InputDecoration(
      labelText: label,
      labelStyle: TextStyle(color: Colors.grey.shade600),
      filled: true,
      fillColor: Colors.grey.shade50,
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: Colors.grey.shade300),
      ),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: Colors.grey.shade300),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: Color(0xFF667eea), width: 2),
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
    );
  }
}
"

.. login
"import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:http/http.dart' as http;
import 'package:riderhub/screens/rider/rider_homescreen.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:country_code_picker/country_code_picker.dart';
import 'dart:convert';
import '../screens/customer/customer_home_screen.dart';
import 'signup_screen.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _phoneController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  bool _obscurePassword = true;
  bool _isLoading = false;
  CountryCode _selectedCode = CountryCode.fromCountryCode('ZW');
  final GoogleSignIn _googleSignIn = GoogleSignIn(scopes: ['email', 'profile']);

  @override
  void dispose() {
    _phoneController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _navigateToHome(String userType) async {
    if (!mounted) return;

    Widget nextScreen = (userType == 'rider' || userType == 'pending_rider')
        ? const RiderHomeScreen()
        : const CustomerHomeScreen();

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Login successful as $userType!'),
        backgroundColor: Colors.green,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ),
    );

    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (context) => nextScreen),
    );
  }

  Future<void> _login() async {
    if (_formKey.currentState!.validate()) {
      final String dialCode = _selectedCode.dialCode ?? '+263';
      String rawPhone = _phoneController.text.trim();

      if (rawPhone.startsWith('0')) {
        rawPhone = rawPhone.substring(1);
      }

      final String fullPhone = dialCode + rawPhone;
      debugPrint('Attempting login for phone: $fullPhone');

      setState(() => _isLoading = true);

      try {
        final response = await http
            .post(
              Uri.parse(
                'https://chareta.com/riderhub/api/api.php?action=login',
              ),
              headers: {'Content-Type': 'application/json'},
              body: jsonEncode({
                'phone': fullPhone,
                'password': _passwordController.text,
              }),
            )
            .timeout(const Duration(seconds: 30));

        if (response.statusCode == 200) {
          final responseData = jsonDecode(response.body);

          if (responseData['error'] == null) {
            // FIXED: Save user_id instead of session_id
            final String userId = responseData['user_id'].toString();
            final String userType = responseData['user_type'] ?? 'customer';

            final prefs = await SharedPreferences.getInstance();
            await prefs.setString('session_id', userId); // This is the fix!
            await prefs.setString('user_type', userType);
            await prefs.setBool('isLoggedIn', true);

            // Profile fetch now uses userId (which is what your backend expects)
            await _fetchAndStoreUserProfile(userId);

            if (mounted) {
              _navigateToHome(userType);
            }
          } else {
            _showError(responseData['error']);
          }
        } else {
          _showError('Login failed: ${response.statusCode} - ${response.body}');
        }
      } catch (e) {
        _showError('Network error: $e');
      } finally {
        if (mounted) setState(() => _isLoading = false);
      }
    }
  }

  Future<void> _signInWithGoogle() async {
    setState(() => _isLoading = true);
    try {
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
      if (googleUser == null) {
        setState(() => _isLoading = false);
        return;
      }

      final googleAuth = await googleUser.authentication;
      if (googleAuth.idToken == null) {
        throw Exception('No ID token received');
      }

      final response = await http
          .post(
            Uri.parse(
              'https://chareta.com/riderhub/api/api.php?action=google_login',
            ),
            headers: {'Content-Type': 'application/json'},
            body: jsonEncode({'id_token': googleAuth.idToken}),
          )
          .timeout(const Duration(seconds: 30));

      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] == null) {
          // ALSO FIXED GOOGLE LOGIN
          final String userId = responseData['user_id'].toString();
          final String userType = responseData['user_type'] ?? 'customer';

          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('session_id', userId); // Save user_id here too!
          await prefs.setString('user_type', userType);
          await prefs.setBool('isLoggedIn', true);
          await _fetchAndStoreUserProfile(userId);

          if (mounted) {
            _navigateToHome(userType);
          }
        } else {
          _showError(responseData['error']);
        }
      } else {
        _showError('Google sign-in failed: ${response.statusCode}');
      }
    } catch (e) {
      _showError('Google sign-in error: $e');
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<void> _fetchAndStoreUserProfile(String userId) async {
    try {
      final response = await http
          .get(
            Uri.parse(
              'https://chareta.com/riderhub/api/api.php?action=profile',
            ),
            headers: {'X-Session-Id': userId}, // Now sends correct user_id
          )
          .timeout(const Duration(seconds: 30));

      if (response.statusCode == 200) {
        final responseData = jsonDecode(response.body);
        if (responseData['error'] == null) {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('user_name', responseData['name'] ?? '');
          await prefs.setString('user_phone', responseData['phone'] ?? '');
          await prefs.setString('user_email', responseData['email'] ?? '');
        }
      }
    } catch (e) {
      debugPrint('Profile fetch error: $e');
    }
  }

  void _showError(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [Color(0xFF667eea), Color(0xFF764ba2), Color(0xFFf093fb)],
            stops: [0.0, 0.6, 1.0],
          ),
        ),
        child: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 32.0),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Your beautiful UI — 100% unchanged
                    Container(
                      width: 140,
                      height: 140,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: Colors.white.withOpacity(0.15),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.2),
                            blurRadius: 25,
                            offset: const Offset(0, 15),
                            spreadRadius: 2,
                          ),
                        ],
                        border: Border.all(
                          color: Colors.white.withOpacity(0.3),
                          width: 2,
                        ),
                      ),
                      child: ClipOval(
                        child: Image.asset(
                          'assets/logo.png',
                          width: 140,
                          height: 140,
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) =>
                              const Icon(
                                Icons.account_circle_rounded,
                                size: 60,
                                color: Colors.white,
                              ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 32.0),
                    Text(
                      'Welcome Back',
                      style: GoogleFonts.inter(
                        color: Colors.white,
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Sign in to continue your journey',
                      style: GoogleFonts.inter(
                        color: Colors.white70,
                        fontSize: 16,
                        fontWeight: FontWeight.w400,
                      ),
                    ),
                    const SizedBox(height: 48.0),

                    // Phone Field
                    Row(
                      children: [
                        CountryCodePicker(
                          onChanged: (code) =>
                              setState(() => _selectedCode = code),
                          initialSelection: 'ZW',
                          favorite: const ['+263', 'ZW'],
                          showCountryOnly: false,
                          alignLeft: false,
                          textStyle: GoogleFonts.inter(
                            fontSize: 18,
                            color: Colors.white,
                          ),
                          padding: const EdgeInsets.symmetric(
                            horizontal: 8,
                            vertical: 4,
                          ),
                          dialogBackgroundColor: Colors.white,
                          backgroundColor: Colors.white.withOpacity(0.12),
                          boxDecoration: BoxDecoration(
                            border: Border.all(
                              color: Colors.white.withOpacity(0.3),
                            ),
                            color: Colors.white.withOpacity(0.12),
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: TextFormField(
                            controller: _phoneController,
                            keyboardType: TextInputType.phone,
                            cursorColor: Colors.white,
                            decoration: InputDecoration(
                              labelText: 'Phone Number',
                              hintText: 'Enter your phone',
                              labelStyle: const TextStyle(
                                color: Colors.white70,
                              ),
                              hintStyle: TextStyle(
                                color: Colors.white.withOpacity(0.5),
                              ),
                              filled: true,
                              fillColor: Colors.white.withOpacity(0.12),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(16),
                                borderSide: BorderSide.none,
                              ),
                              focusedBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(16),
                                borderSide: const BorderSide(
                                  color: Colors.white54,
                                  width: 1.5,
                                ),
                              ),
                              contentPadding: const EdgeInsets.symmetric(
                                vertical: 20,
                                horizontal: 20,
                              ),
                            ),
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                            ),
                            validator: (value) => value == null || value.isEmpty
                                ? 'Please enter your phone number'
                                : null,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 20.0),

                    // Password Field
                    TextFormField(
                      controller: _passwordController,
                      obscureText: _obscurePassword,
                      cursorColor: Colors.white,
                      decoration: InputDecoration(
                        labelText: 'Password',
                        hintText: 'Enter your password',
                        prefixIcon: Container(
                          margin: const EdgeInsets.all(12),
                          child: const Icon(
                            Icons.lock_rounded,
                            color: Colors.white70,
                            size: 24,
                          ),
                        ),
                        suffixIcon: Container(
                          margin: const EdgeInsets.all(12),
                          child: IconButton(
                            icon: Icon(
                              _obscurePassword
                                  ? Icons.visibility_off_rounded
                                  : Icons.visibility_rounded,
                              color: Colors.white70,
                              size: 24,
                            ),
                            onPressed: () => setState(
                              () => _obscurePassword = !_obscurePassword,
                            ),
                          ),
                        ),
                        labelStyle: const TextStyle(color: Colors.white70),
                        hintStyle: TextStyle(
                          color: Colors.white.withOpacity(0.5),
                        ),
                        filled: true,
                        fillColor: Colors.white.withOpacity(0.12),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(16),
                          borderSide: BorderSide.none,
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(16),
                          borderSide: const BorderSide(
                            color: Colors.white54,
                            width: 1.5,
                          ),
                        ),
                        contentPadding: const EdgeInsets.symmetric(
                          vertical: 20,
                          horizontal: 20,
                        ),
                      ),
                      style: const TextStyle(color: Colors.white, fontSize: 16),
                      validator: (value) {
                        if (value == null || value.isEmpty)
                          return 'Please enter your password';
                        if (value.length < 6)
                          return 'Password must be at least 6 characters';
                        return null;
                      },
                    ),
                    const SizedBox(height: 8.0),

                    Align(
                      alignment: Alignment.centerRight,
                      child: TextButton(
                        onPressed: () {},
                        child: Text(
                          'Forgot Password?',
                          style: GoogleFonts.inter(
                            color: Colors.white70,
                            fontSize: 14,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 32.0),

                    SizedBox(
                      width: double.infinity,
                      height: 58,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _login,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.white,
                          foregroundColor: const Color(0xFF667eea),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                          elevation: 6,
                          shadowColor: Colors.black.withOpacity(0.3),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                width: 20,
                                height: 20,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  valueColor: AlwaysStoppedAnimation<Color>(
                                    Color(0xFF667eea),
                                  ),
                                ),
                              )
                            : Text(
                                'Sign In',
                                style: GoogleFonts.inter(
                                  fontSize: 18,
                                  fontWeight: FontWeight.w700,
                                  letterSpacing: 0.5,
                                ),
                              ),
                      ),
                    ),
                    const SizedBox(height: 28.0),

                    // Divider + Social Buttons + Sign Up Link — 100% untouched
                    Row(
                      children: [
                        Expanded(
                          child: Divider(
                            color: Colors.white.withOpacity(0.3),
                            thickness: 1,
                          ),
                        ),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          child: Text(
                            'Or continue with',
                            style: GoogleFonts.inter(
                              color: Colors.white.withOpacity(0.7),
                              fontSize: 14,
                            ),
                          ),
                        ),
                        Expanded(
                          child: Divider(
                            color: Colors.white.withOpacity(0.3),
                            thickness: 1,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 28.0),

                    Row(
                      children: [
                        Expanded(
                          child: Container(
                            height: 56,
                            decoration: BoxDecoration(
                              color: Colors.white,
                              borderRadius: BorderRadius.circular(16),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.1),
                                  blurRadius: 10,
                                  offset: const Offset(0, 4),
                                ),
                              ],
                            ),
                            child: TextButton.icon(
                              onPressed: _isLoading ? null : _signInWithGoogle,
                              icon: Container(
                                padding: const EdgeInsets.all(2),
                                child: const Text(
                                  'G',
                                  style: TextStyle(
                                    color: Color(0xFF4285F4),
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                              label: Text(
                                'Google',
                                style: GoogleFonts.inter(
                                  color: Colors.black87,
                                  fontSize: 15,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                              style: TextButton.styleFrom(
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(16),
                                ),
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: Container(
                            height: 56,
                            decoration: BoxDecoration(
                              border: Border.all(
                                color: Colors.white70,
                                width: 1.5,
                              ),
                              borderRadius: BorderRadius.circular(16),
                            ),
                            child: TextButton.icon(
                              onPressed: () {},
                              icon: const Icon(
                                Icons.phone_iphone_rounded,
                                color: Colors.white70,
                                size: 20,
                              ),
                              label: Text(
                                'Phone',
                                style: GoogleFonts.inter(
                                  color: Colors.white70,
                                  fontSize: 15,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                              style: TextButton.styleFrom(
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(16),
                                ),
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 40.0),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(
                          "Don't have an account? ",
                          style: GoogleFonts.inter(
                            color: Colors.white70,
                            fontSize: 15,
                          ),
                        ),
                        GestureDetector(
                          onTap: () => Navigator.pushReplacement(
                            context,
                            MaterialPageRoute(
                              builder: (context) => const SignupScreen(),
                            ),
                          ),
                          child: Text(
                            'Sign Up',
                            style: GoogleFonts.inter(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 40.0),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}
"
i also have "// lib/screens/customer/customer_home_screen.dart
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:riderhub/screens/customer/send_request_screen.dart';
import 'package:riderhub/screens/customer/track_delivery_screen.dart';
import 'package:riderhub/screens/customer/delivery_history_screen.dart';
import 'package:riderhub/screens/customer/notifications_screen.dart';
import 'package:riderhub/screens/customer/settings_screen.dart';
import 'package:riderhub/screens/customer/apply_rider_screen.dart';
import 'package:riderhub/screens/rider/rider_status_screen.dart';

class CustomerHomeScreen extends StatefulWidget {
  const CustomerHomeScreen({super.key});

  @override
  State<CustomerHomeScreen> createState() => _CustomerHomeScreenState();
}

class _CustomerHomeScreenState extends State<CustomerHomeScreen> {
  int _currentIndex = 0;

  String _userName = 'User';
  String _userPhone = '';
  String _userType = 'customer';
  bool _isLoading = true;
  Map<String, dynamic>? _applicationData;

  @override
  void initState() {
    super.initState();
    _loadUserProfile();
  }

  Future<void> _loadUserProfile() async {
    final prefs = await SharedPreferences.getInstance();
    final sessionId = prefs.getString('session_id');

    if (sessionId == null) {
      setState(() => _isLoading = false);
      return;
    }

    try {
      final response = await http
          .get(
            Uri.parse(
              'https://chareta.com/riderhub/api/api.php?action=profile',
            ),
            headers: {'X-Session-Id': sessionId},
          )
          .timeout(const Duration(seconds: 10));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        if (data['error'] == null) {
          setState(() {
            _userName = data['name'] ?? 'User';
            _userPhone = data['phone'] ?? '';
            _userType = data['user_type'] ?? 'customer';
            _isLoading = false;
          });
          // Cache
          prefs.setString('user_name', _userName);
          prefs.setString('user_phone', _userPhone);
          prefs.setString('user_type', _userType);
        }
      }

      // Load application status after profile
      await _loadApplicationStatus();
    } catch (e) {
      debugPrint('Profile load error: $e');
    } finally {
      setState(() => _isLoading = false);
    }
  }

  Future<void> _loadApplicationStatus() async {
    final prefs = await SharedPreferences.getInstance();
    final sessionId = prefs.getString('session_id');

    if (sessionId == null) return;

    try {
      final response = await http
          .get(
            Uri.parse(
              'https://chareta.com/riderhub/api/api.php?action=rider_application_status',
            ),
            headers: {'X-Session-Id': sessionId},
          )
          .timeout(const Duration(seconds: 10));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        setState(() {
          _applicationData = data;
        });
      }
    } catch (e) {
      debugPrint('Application status load error: $e');
    }
  }

  Future<void> _logout() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.clear();
    if (mounted) {
      Navigator.pushNamedAndRemoveUntil(context, '/login', (route) => false);
    }
  }

  void _onTabTapped(int index) {
    setState(() => _currentIndex = index);
  }

  Widget _buildApplicationStatusCard() {
    final status = _applicationData?['status'] ?? 'not_applied';
    final riderCode = _applicationData?['rider_code'];
    final rejectionReason = _applicationData?['rejection_reason'];

    switch (status) {
      case 'pending':
        return Card(
          color: Colors.orange.shade50,
          child: ListTile(
            leading: const Icon(Icons.hourglass_empty, color: Colors.orange),
            title: Text(
              'Rider Application Pending',
              style: GoogleFonts.inter(fontWeight: FontWeight.w600),
            ),
            subtitle: const Text('We are reviewing your documents'),
            trailing: const Icon(Icons.arrow_forward_ios, size: 16),
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const RiderStatusScreen()),
            ),
          ),
        );

      case 'approved':
        return Card(
          color: Colors.green.shade50,
          child: ListTile(
            leading: const Icon(Icons.check_circle, color: Colors.green),
            title: Text(
              'Rider Application Approved!',
              style: GoogleFonts.inter(fontWeight: FontWeight.w600),
            ),
            subtitle: Text(
              riderCode != null
                  ? 'Rider Code: $riderCode'
                  : 'You are now a rider!',
            ),
            trailing: const Icon(Icons.arrow_forward_ios, size: 16),
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const RiderStatusScreen()),
            ),
          ),
        );

      case 'rejected':
        return Card(
          color: Colors.red.shade50,
          child: ListTile(
            leading: const Icon(Icons.cancel, color: Colors.red),
            title: Text(
              'Application Rejected',
              style: GoogleFonts.inter(fontWeight: FontWeight.w600),
            ),
            subtitle: Text(
              rejectionReason?.isNotEmpty == true
                  ? rejectionReason!
                  : 'Tap to view details',
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
            ),
            trailing: const Icon(Icons.arrow_forward_ios, size: 16),
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const RiderStatusScreen()),
            ),
          ),
        );

      default: // 'not_applied' or any other status
        return Card(
          child: ListTile(
            leading: const Icon(Icons.motorcycle, color: Color(0xFF667eea)),
            title: Text(
              'Become a Rider',
              style: GoogleFonts.inter(fontWeight: FontWeight.w600),
            ),
            subtitle: const Text('Earn extra income delivering'),
            trailing: const Icon(Icons.arrow_forward_ios),
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const ApplyRiderScreen()),
            ),
          ),
        );
    }
  }

  @override
  Widget build(BuildContext context) {
    final List<Widget> pages = [
      _buildHomeTab(),
      const DeliveryHistoryScreen(),
      const NotificationsScreen(),
      const SettingsScreen(),
    ];

    return Scaffold(
      body: NestedScrollView(
        headerSliverBuilder: (context, innerBoxIsScrolled) => [
          SliverAppBar(
            expandedHeight: 180,
            floating: false,
            pinned: true,
            flexibleSpace: FlexibleSpaceBar(
              title: Text(
                'Hello, ${_userName.split(' ').first}',
                style: GoogleFonts.inter(fontWeight: FontWeight.bold),
              ),
              background: Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [Color(0xFF667eea), Color(0xFF764ba2)],
                  ),
                ),
                child: Stack(
                  children: [
                    Positioned(
                      right: -50,
                      top: -50,
                      child: Container(
                        width: 200,
                        height: 200,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          color: Colors.white.withOpacity(0.1),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
            actions: [
              IconButton(
                icon: const Icon(Icons.logout),
                onPressed: _logout,
                tooltip: 'Logout',
              ),
            ],
          ),
        ],
        body: pages[_currentIndex],
      ),
      floatingActionButton: _currentIndex == 0
          ? FloatingActionButton.extended(
              onPressed: () => Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const SendRequestScreen()),
              ),
              backgroundColor: const Color(0xFF667eea),
              icon: const Icon(Icons.add, color: Colors.white),
              label: Text(
                'New Delivery',
                style: GoogleFonts.inter(
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                ),
              ),
            )
          : null,
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _currentIndex,
        onTap: _onTabTapped,
        type: BottomNavigationBarType.fixed,
        selectedItemColor: const Color(0xFF667eea),
        unselectedItemColor: Colors.grey,
        selectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600),
        items: [
          const BottomNavigationBarItem(
            icon: Icon(Icons.home_outlined),
            label: 'Home',
          ),
          const BottomNavigationBarItem(
            icon: Icon(Icons.history),
            label: 'History',
          ),
          const BottomNavigationBarItem(
            icon: Icon(Icons.notifications_outlined),
            label: 'Alerts',
          ),
          const BottomNavigationBarItem(
            icon: Icon(Icons.settings_outlined),
            label: 'Settings',
          ),
        ],
      ),
    );
  }

  Widget _buildHomeTab() {
    return RefreshIndicator(
      onRefresh: () async {
        await _loadUserProfile();
        await _loadApplicationStatus();
      },
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const SizedBox(height: 20),

            // Welcome Card
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  colors: [Color(0xFF667eea), Color(0xFF764ba2)],
                ),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black26,
                    blurRadius: 10,
                    offset: const Offset(0, 5),
                  ),
                ],
              ),
              child: Column(
                children: [
                  const Icon(
                    Icons.waving_hand,
                    size: 40,
                    color: Colors.white70,
                  ),
                  const SizedBox(height: 12),
                  Text(
                    'Welcome back!',
                    style: GoogleFonts.inter(
                      fontSize: 26,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  Text(
                    'What would you like to deliver today?',
                    style: GoogleFonts.inter(
                      fontSize: 16,
                      color: Colors.white70,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),

            const SizedBox(height: 32),

            // Quick Actions
            Text(
              'Quick Actions',
              style: GoogleFonts.inter(
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),

            const SizedBox(height: 16),
            GridView.count(
              shrinkWrap: true,
              physics: const NeverScrollableScrollPhysics(),
              crossAxisCount: 2,
              crossAxisSpacing: 16,
              mainAxisSpacing: 16,
              childAspectRatio: 1.2,
              children: [
                _actionCard(
                  Icons.send_outlined,
                  'Send Request',
                  const Color(0xFF667eea),
                  () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (_) => const SendRequestScreen(),
                      ),
                    );
                  },
                ),
                _actionCard(
                  Icons.track_changes,
                  'Track Delivery',
                  Colors.green,
                  () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (_) =>
                            const TrackDeliveryScreen(deliveryId: 'latest'),
                      ),
                    );
                  },
                ),
                _actionCard(
                  Icons.history,
                  'History',
                  Colors.amber.shade700,
                  () {
                    setState(() => _currentIndex = 1);
                  },
                ),
                _actionCard(Icons.card_giftcard, 'Offers', Colors.purple, () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('Offers coming soon!')),
                  );
                }),
              ],
            ),

            const SizedBox(height: 32),

            // Rider Application Status
            _buildApplicationStatusCard(),

            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _actionCard(
    IconData icon,
    String title,
    Color color,
    VoidCallback onTap,
  ) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: color.withOpacity(0.1),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: color.withOpacity(0.3)),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 36, color: color),
            const SizedBox(height: 12),
            Text(
              title,
              style: GoogleFonts.inter(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: Colors.black87,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }
}
"

when i click on the become a rider
" return Card(
          child: ListTile(
            leading: const Icon(Icons.motorcycle, color: Color(0xFF667eea)),
            title: Text(
              'Become a Rider',
              style: GoogleFonts.inter(fontWeight: FontWeight.w600),
            ),
            subtitle: const Text('Earn extra income delivering'),
            trailing: const Icon(Icons.arrow_forward_ios),
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const ApplyRiderScreen()),"


. "i get an error login session  lost . please restart the app"
.. help me there

yes its registering and login in
but this 

". "i get an error login session  lost . please restart the app""

.. because i would want to submit data here

"// lib/screens/customer/apply_rider_screen.dart
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:http/http.dart' as http;
import 'package:riderhub/screens/rider/rider_status_screen.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';
import 'package:image_picker/image_picker.dart';
import 'dart:typed_data';

class ApplyRiderScreen extends StatefulWidget {
  const ApplyRiderScreen({super.key});

  @override
  State<ApplyRiderScreen> createState() => _ApplyRiderScreenState();
}

class _ApplyRiderScreenState extends State<ApplyRiderScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  bool _isLoading = false;
  bool _isCheckingStatus = false;
  String? _sessionId;
  String? _applicationStatus;
  String? _riderCode;
  String? _rejectionReason;

  // Form Controllers
  final TextEditingController _fullNameController = TextEditingController();
  final TextEditingController _idNumberController = TextEditingController();
  final TextEditingController _addressController = TextEditingController();
  final TextEditingController _emergencyContactController =
      TextEditingController();
  final TextEditingController _vehicleTypeController = TextEditingController();
  final TextEditingController _vehicleModelController = TextEditingController();
  final TextEditingController _vehicleYearController = TextEditingController();
  final TextEditingController _vehicleRegController = TextEditingController();
  final TextEditingController _licenseNumberController =
      TextEditingController();

  // Images
  Uint8List? _idFrontBytes;
  Uint8List? _idBackBytes;
  Uint8List? _vehicleFrontBytes;
  Uint8List? _vehicleBackBytes;
  Uint8List? _licenseBytes;

  final ImagePicker _picker = ImagePicker();

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _loadValidSessionAndCheckStatus();
  }

  @override
  void dispose() {
    _tabController.dispose();
    _fullNameController.dispose();
    _idNumberController.dispose();
    _addressController.dispose();
    _emergencyContactController.dispose();
    _vehicleTypeController.dispose();
    _vehicleModelController.dispose();
    _vehicleYearController.dispose();
    _vehicleRegController.dispose();
    _licenseNumberController.dispose();
    super.dispose();
  }

  // AUTO-FIXES SESSION + CHECKS STATUS
  // REPLACE YOUR _loadValidSessionAndCheckStatus WITH THIS
  Future<void> _loadValidSessionAndCheckStatus() async {
    final prefs = await SharedPreferences.getInstance();
    String? savedSession = prefs.getString('session_id');
    final int? savedUserId = prefs.getInt('user_id');

    // ALWAYS TRY TO GET REAL SESSION — EVEN IF WE THINK WE HAVE ONE
    final userId =
        savedUserId ??
        (savedSession != null && int.tryParse(savedSession) != null
            ? int.parse(savedSession)
            : null);

    if (userId != null) {
      try {
        final response = await http
            .get(
              Uri.parse(
                'https://chareta.com/riderhub/api/api.php?action=get_session',
              ),
              headers: {'X-User-Id': userId.toString()},
            )
            .timeout(const Duration(seconds: 15));

        if (response.statusCode == 200) {
          final data = jsonDecode(response.body);
          final realSession = data['session_id']?.toString();
          if (realSession != null && realSession.length > 20) {
            await prefs.setString('session_id', realSession);
            savedSession = realSession;
            debugPrint('FORCED SESSION RECOVERY SUCCESS: $realSession');
          }
        }
      } catch (e) {
        debugPrint('Session recovery failed: $e');
      }
    }

    _sessionId = savedSession ?? userId.toString();

    if (_sessionId == null ||
        _sessionId!.trim().isEmpty ||
        _sessionId!.length < 10) {
      _showError('Login session lost. Please restart app.');
      return;
    }

    debugPrint('FINAL SESSION ID USED: $_sessionId');
    setState(() {});

    await _checkApplicationStatus();
  }

  Future<void> _checkApplicationStatus() async {
    if (_sessionId == null || _sessionId!.isEmpty) return;
    setState(() => _isCheckingStatus = true);

    try {
      final response = await http.get(
        Uri.parse(
          'https://chareta.com/riderhub/api/api.php?action=rider_application_status',
        ),
        headers: {'X-Session-Id': _sessionId!},
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final status = data['status']?.toString().toLowerCase();
        setState(() {
          if (status == 'pending' ||
              status == 'approved' ||
              status == 'rejected') {
            _applicationStatus = status;
            _riderCode = data['rider_code']?.toString();
            _rejectionReason = data['rejection_reason'];
          } else {
            _applicationStatus = null;
          }
        });
      }
    } catch (e) {
      debugPrint('Status check error: $e');
    } finally {
      setState(() => _isCheckingStatus = false);
    }
  }

  Future<void> _submitApplication() async {
    // FORCE RECOVER REAL SESSION BEFORE ANYTHING
    await _loadValidSessionAndCheckStatus();

    if (_sessionId == null ||
        _sessionId!.trim().isEmpty ||
        _sessionId!.length < 10) {
      _showError('Cannot submit: Invalid session. Restart app and try again.');
      return;
    }

    // Rest of validation...
    if (_fullNameController.text.trim().isEmpty ||
        _idNumberController.text.trim().isEmpty ||
        _vehicleTypeController.text.trim().isEmpty ||
        _vehicleRegController.text.trim().isEmpty ||
        _idFrontBytes == null ||
        _idBackBytes == null ||
        _vehicleFrontBytes == null ||
        _vehicleBackBytes == null) {
      _showError('Please complete all required fields');
      return;
    }

    setState(() => _isLoading = true);

    try {
      var request = http.MultipartRequest(
        'POST',
        Uri.parse(
          'https://chareta.com/riderhub/api/api.php?action=apply_rider',
        ),
      );

      // THIS WILL NOW BE THE REAL LONG SESSION
      request.headers['X-Session-Id'] = _sessionId!;

      // ... rest of your fields and images (unchanged)
      request.fields.addAll({
        'full_name': _fullNameController.text.trim(),
        'id_number': _idNumberController.text.trim(),
        'address': _addressController.text.trim(),
        'emergency_contact': _emergencyContactController.text.trim(),
        'vehicle_type': _vehicleTypeController.text.trim(),
        'vehicle_model': _vehicleModelController.text.trim(),
        'vehicle_year': _vehicleYearController.text.trim(),
        'vehicle_registration': _vehicleRegController.text.trim(),
        'license_number': _licenseNumberController.text.trim(),
      });

      final images = {
        'id_front_image': _idFrontBytes,
        'id_back_image': _idBackBytes,
        'vehicle_front_image': _vehicleFrontBytes,
        'vehicle_back_image': _vehicleBackBytes,
        'license_image': _licenseBytes,
      };

      images.forEach((key, bytes) {
        if (bytes != null) {
          request.files.add(
            http.MultipartFile.fromBytes(key, bytes, filename: '$key.jpg'),
          );
        }
      });

      final streamedResponse = await request.send().timeout(
        const Duration(seconds: 80),
      );
      final responseBody = await streamedResponse.stream.bytesToString();

      debugPrint('RESPONSE: $responseBody');

      if (streamedResponse.statusCode == 200) {
        final data = jsonDecode(responseBody);
        if (data['success'] == true || data['rider_code'] != null) {
          final riderCode = data['rider_code'] ?? 'RDR-???';
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('rider_code', riderCode);

          if (mounted) {
            showDialog(
              context: context,
              barrierDismissible: false,
              builder: (_) => AlertDialog(
                title: const Text('SUCCESS!'),
                content: Text(
                  'Application Submitted!\n\nYour Rider Code:\n$riderCode',
                ),
                actions: [
                  TextButton(
                    onPressed: () => Navigator.pushReplacement(
                      context,
                      MaterialPageRoute(
                        builder: (_) => const RiderStatusScreen(),
                      ),
                    ),
                    child: const Text('Go to Status'),
                  ),
                ],
              ),
            );
          }
        } else {
          _showError(data['message'] ?? 'Unknown error');
        }
      } else {
        _showError('Server error ${streamedResponse.statusCode}');
      }
    } catch (e) {
      _showError('Network error: $e');
    } finally {
      setState(() => _isLoading = false);
    }
  }

  void _showError(String msg) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(msg),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 10),
      ),
    );
  }

  Future<void> _pickImage(ImageSource source, String type) async {
    try {
      final XFile? file = await _picker.pickImage(
        source: source,
        imageQuality: 80,
      );
      if (file != null) {
        final bytes = await file.readAsBytes();
        setState(() {
          switch (type) {
            case 'id_front':
              _idFrontBytes = bytes;
              break;
            case 'id_back':
              _idBackBytes = bytes;
              break;
            case 'vehicle_front':
              _vehicleFrontBytes = bytes;
              break;
            case 'vehicle_back':
              _vehicleBackBytes = bytes;
              break;
            case 'license':
              _licenseBytes = bytes;
              break;
          }
        });
      }
    } catch (e) {
      _showError('Image pick failed: $e');
    }
  }

  void _removeImage(String type) {
    setState(() {
      switch (type) {
        case 'id_front':
          _idFrontBytes = null;
          break;
        case 'id_back':
          _idBackBytes = null;
          break;
        case 'vehicle_front':
          _vehicleFrontBytes = null;
          break;
        case 'vehicle_back':
          _vehicleBackBytes = null;
          break;
        case 'license':
          _licenseBytes = null;
          break;
      }
    });
  }

  void _showImageSourceDialog(String type) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text('Select Source'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ListTile(
              leading: const Icon(Icons.camera),
              title: const Text('Camera'),
              onTap: () {
                Navigator.pop(context);
                _pickImage(ImageSource.camera, type);
              },
            ),
            ListTile(
              leading: const Icon(Icons.photo_library),
              title: const Text('Gallery'),
              onTap: () {
                Navigator.pop(context);
                _pickImage(ImageSource.gallery, type);
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildImagePreview(
    Uint8List? bytes,
    String type, {
    String label = '',
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        if (label.isNotEmpty)
          Text(label, style: GoogleFonts.inter(fontSize: 14)),
        const SizedBox(height: 8),
        GestureDetector(
          onTap: () => _showImageSourceDialog(type),
          child: Container(
            height: 140,
            width: double.infinity,
            decoration: BoxDecoration(
              border: Border.all(
                color: bytes == null
                    ? Colors.grey.shade400
                    : Colors.grey.shade300,
              ),
              borderRadius: BorderRadius.circular(12),
              color: Colors.grey.shade50,
            ),
            child: bytes != null
                ? Stack(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(12),
                        child: Image.memory(
                          bytes,
                          fit: BoxFit.cover,
                          width: double.infinity,
                          height: double.infinity,
                        ),
                      ),
                      Positioned(
                        top: 8,
                        right: 8,
                        child: GestureDetector(
                          onTap: () => _removeImage(type),
                          child: const CircleAvatar(
                            backgroundColor: Colors.red,
                            radius: 14,
                            child: Icon(
                              Icons.close,
                              size: 18,
                              color: Colors.white,
                            ),
                          ),
                        ),
                      ),
                    ],
                  )
                : Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.camera_alt,
                        size: 40,
                        color: Colors.grey.shade500,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Tap to upload',
                        style: GoogleFonts.inter(color: Colors.grey.shade600),
                      ),
                    ],
                  ),
          ),
        ),
      ],
    );
  }

  Widget _buildPersonalDetailsTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          TextFormField(
            controller: _fullNameController,
            decoration: const InputDecoration(
              labelText: 'Full Name *',
              border: OutlineInputBorder(),
            ),
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _idNumberController,
            decoration: const InputDecoration(
              labelText: 'ID Number *',
              border: OutlineInputBorder(),
            ),
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _addressController,
            decoration: const InputDecoration(
              labelText: 'Address',
              border: OutlineInputBorder(),
            ),
            maxLines: 2,
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _emergencyContactController,
            decoration: const InputDecoration(
              labelText: 'Emergency Contact',
              border: OutlineInputBorder(),
            ),
            keyboardType: TextInputType.phone,
          ),
          const SizedBox(height: 24),
          const Text(
            'ID Photos *',
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: _buildImagePreview(
                  _idFrontBytes,
                  'id_front',
                  label: 'Front Side *',
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: _buildImagePreview(
                  _idBackBytes,
                  'id_back',
                  label: 'Back Side *',
                ),
              ),
            ],
          ),
          const SizedBox(height: 32),
          ElevatedButton(
            onPressed: () => _tabController.animateTo(1),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF667eea),
              foregroundColor: Colors.white,
              minimumSize: const Size(double.infinity, 50),
            ),
            child: const Text(
              'Next: Vehicle Details',
              style: TextStyle(fontWeight: FontWeight.bold),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildVehicleDetailsTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          TextFormField(
            controller: _vehicleTypeController,
            decoration: const InputDecoration(
              labelText: 'Vehicle Type * (e.g. Motorcycle)',
              border: OutlineInputBorder(),
            ),
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _vehicleModelController,
            decoration: const InputDecoration(
              labelText: 'Model',
              border: OutlineInputBorder(),
            ),
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _vehicleYearController,
            decoration: const InputDecoration(
              labelText: 'Year',
              border: OutlineInputBorder(),
            ),
            keyboardType: TextInputType.number,
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _vehicleRegController,
            decoration: const InputDecoration(
              labelText: 'Registration Number *',
              border: OutlineInputBorder(),
            ),
          ),
          const SizedBox(height: 16),
          TextFormField(
            controller: _licenseNumberController,
            decoration: const InputDecoration(
              labelText: 'License Number',
              border: OutlineInputBorder(),
            ),
          ),
          const SizedBox(height: 24),
          const Text(
            'Vehicle Photos *',
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 16),
          _buildImagePreview(
            _vehicleFrontBytes,
            'vehicle_front',
            label: 'Front View *',
          ),
          const SizedBox(height: 16),
          _buildImagePreview(
            _vehicleBackBytes,
            'vehicle_back',
            label: 'Back View *',
          ),
          const SizedBox(height: 16),
          _buildImagePreview(
            _licenseBytes,
            'license',
            label: 'Driving License',
          ),
          const SizedBox(height: 32),
          Row(
            children: [
              Expanded(
                child: OutlinedButton(
                  onPressed: () => _tabController.animateTo(0),
                  child: const Text('Back'),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: ElevatedButton(
                  onPressed: () => _tabController.animateTo(2),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF667eea),
                    foregroundColor: Colors.white,
                  ),
                  child: const Text('Next: Review'),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildReviewTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Review Your Application',
            style: GoogleFonts.inter(fontSize: 22, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 20),
          _reviewItem('Full Name', _fullNameController.text),
          _reviewItem('ID Number', _idNumberController.text),
          _reviewItem('Vehicle Type', _vehicleTypeController.text),
          _reviewItem('Registration', _vehicleRegController.text),
          const SizedBox(height: 30),
          Row(
            children: [
              Expanded(
                child: OutlinedButton(
                  onPressed: () => _tabController.animateTo(1),
                  child: const Text('Back'),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _submitApplication,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF667eea),
                    foregroundColor: Colors.white,
                    minimumSize: const Size(0, 50),
                  ),
                  child: _isLoading
                      ? const CircularProgressIndicator(color: Colors.white)
                      : const Text(
                          'Submit Application',
                          style: TextStyle(fontWeight: FontWeight.bold),
                        ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _reviewItem(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 140,
            child: Text(
              '$label:',
              style: const TextStyle(fontWeight: FontWeight.bold),
            ),
          ),
          Expanded(child: Text(value.isEmpty ? 'Not provided' : value)),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_applicationStatus != null && _applicationStatus != 'not_applied') {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (_) => const RiderStatusScreen()),
        );
      });
      return const Scaffold(body: Center(child: CircularProgressIndicator()));
    }

    if (_isCheckingStatus) {
      return const Scaffold(body: Center(child: CircularProgressIndicator()));
    }

    return Scaffold(
      appBar: AppBar(
        title: const Text('Apply to be a Rider'),
        backgroundColor: const Color(0xFF667eea),
        foregroundColor: Colors.white,
        bottom: PreferredSize(
          preferredSize: const Size.fromHeight(100),
          child: Column(
            children: [
              LinearProgressIndicator(
                value: (_tabController.index + 1) / 3,
                backgroundColor: Colors.white24,
                valueColor: const AlwaysStoppedAnimation(Colors.white),
              ),
              TabBar(
                controller: _tabController,
                tabs: const [
                  Tab(text: 'Personal'),
                  Tab(text: 'Vehicle'),
                  Tab(text: 'Review'),
                ],
              ),
            ],
          ),
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildPersonalDetailsTab(),
          _buildVehicleDetailsTab(),
          _buildReviewTab(),
        ],
      ),
    );
  }
}
"
.. 

.. of which the rider application status i would want to show here

rider_status_screen "// lib/screens/customer/rider_status_screen.dart

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:http/http.dart' as http;
import 'package:riderhub/screens/customer/apply_rider_screen.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class RiderStatusScreen extends StatefulWidget {
  const RiderStatusScreen({super.key});

  @override
  State<RiderStatusScreen> createState() {
    return _RiderStatusScreenState();
  }
}

class _RiderStatusScreenState extends State<RiderStatusScreen> {
  Map<String, dynamic>? _applicationData;
  bool _isLoading = true;
  String? _error;
  bool _showDebugPanel = true; // Set false in production

  String _debugInfo = '';

  @override
  void initState() {
    super.initState();
    _loadApplicationStatus();
  }

  void _addDebug(String message) {
    if (!mounted) return;

    final time = DateTime.now().toString().substring(11, 23);
    final line = '[$time] $message';
    debugPrint('RIDER_STATUS_DEBUG: $line');

    if (mounted) {
      setState(() {
        _debugInfo += '$line\n';
      });
    }
  }

  Future<void> _loadApplicationStatus() async {
    if (!mounted) return;

    setState(() {
      _isLoading = true;
      _error = null;
      _debugInfo = '=== STATUS CHECK STARTED ===\n';
    });

    _addDebug('_loadApplicationStatus called');

    final prefs = await SharedPreferences.getInstance();
    final sessionId =
        prefs.getString('session_id') ?? prefs.getString('user_id');
    final cachedRiderCode = prefs.getString('rider_code');

    _addDebug('Using Session ID: "$sessionId"');
    _addDebug('Cached Rider Code: ${cachedRiderCode ?? "none"}');

    if (sessionId == null || sessionId.trim().isEmpty) {
      if (!mounted) return;
      setState(() {
        _error = 'No session found. Please log in again.';
        _isLoading = false;
      });
      return;
    }

    try {
      final response = await http
          .get(
            Uri.parse(
              'https://chareta.com/riderhub/api/api.php?action=rider_application_status',
            ),
            headers: {'X-Session-Id': sessionId},
          )
          .timeout(const Duration(seconds: 20));

      _addDebug('HTTP ${response.statusCode}');
      _addDebug('Response: ${response.body}');

      if (!mounted) return;

      if (response.statusCode == 200 && response.body.trim().isNotEmpty) {
        try {
          final data = jsonDecode(response.body);

          // Cache rider_code if present
          if (data is Map<String, dynamic> && data['rider_code'] != null) {
            await prefs.setString('rider_code', data['rider_code']);
          }

          setState(() {
            _applicationData = data is Map<String, dynamic> ? data : null;
            _isLoading = false;
          });

          _addDebug('Parsed data: $data');
          return;
        } catch (e) {
          _addDebug('JSON parse failed: $e');
        }
      }

      // === FALLBACK LOGIC: API failed or returned garbage ===
      _addDebug('API failed → using fallback logic');

      if (cachedRiderCode != null && cachedRiderCode.startsWith('RDR-')) {
        _addDebug('Found cached rider_code → showing PENDING');
        setState(() {
          _applicationData = {
            'status': 'pending',
            'rider_code': cachedRiderCode,
          };
          _isLoading = false;
        });
      } else {
        setState(() {
          _error = 'Server temporarily unavailable. Showing last known status.';
          _isLoading = false;
        });
      }
    } catch (e) {
      _addDebug('Exception: $e');
      if (!mounted) return;

      // Even on timeout/exception → try to show cached status
      if (cachedRiderCode != null && cachedRiderCode.startsWith('RDR-')) {
        _addDebug(
          'Network error but cached rider_code exists → showing PENDING',
        );
        setState(() {
          _applicationData = {
            'status': 'pending',
            'rider_code': cachedRiderCode,
          };
          _isLoading = false;
        });
      } else {
        setState(() {
          _error = 'Connection failed. Retrying...';
          _isLoading = false;
        });
      }
    }
  }

  Widget _buildStatusView({
    required IconData icon,
    required Color color,
    required String title,
    required String subtitle,
    String? riderCode,
    Widget? actionButton,
  }) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: <Widget>[
          Icon(icon, size: 100, color: color),
          const SizedBox(height: 24),
          Text(
            title,
            style: GoogleFonts.inter(fontSize: 28, fontWeight: FontWeight.bold),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          Text(
            subtitle,
            style: GoogleFonts.inter(fontSize: 16),
            textAlign: TextAlign.center,
          ),
          if (riderCode != null) ...[
            const SizedBox(height: 32),
            Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: color.withOpacity(0.15),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: color, width: 2),
              ),
              child: Text(
                'Rider Code: $riderCode',
                style: GoogleFonts.inter(
                  fontSize: 22,
                  fontWeight: FontWeight.bold,
                  color: color,
                ),
              ),
            ),
          ],
          if (actionButton != null) ...[
            const SizedBox(height: 40),
            actionButton,
          ],
        ],
      ),
    );
  }

  Widget _buildMainContent() {
    if (_isLoading) {
      return const Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            CircularProgressIndicator(color: Color(0xFF667eea)),
            SizedBox(height: 20),
            Text('Checking your application status...'),
          ],
        ),
      );
    }

    if (_error != null) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            const Icon(Icons.cloud_off, size: 80, color: Colors.orange),
            const SizedBox(height: 20),
            Text(
              'Temporary Server Issue',
              style: GoogleFonts.inter(
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 10),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 40),
              child: Text(
                _error!,
                textAlign: TextAlign.center,
                style: const TextStyle(color: Colors.grey),
              ),
            ),
            const SizedBox(height: 20),
            ElevatedButton.icon(
              onPressed: _loadApplicationStatus,
              icon: const Icon(Icons.refresh),
              label: const Text('Retry'),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF667eea),
              ),
            ),
          ],
        ),
      );
    }

    final String? rawStatus = _applicationData?['status']?.toString().trim();
    final String status = (rawStatus ?? '').toLowerCase();

    _addDebug('Final status: "$status" (raw: "$rawStatus")');

    if (status == 'not_applied' || status.isEmpty || _applicationData == null) {
      return _buildStatusView(
        icon: Icons.motorcycle,
        color: const Color(0xFF667eea),
        title: 'Become a Chareta Rider!',
        subtitle:
            'Earn money on your own schedule.\nFlexible hours • Great earnings',
        actionButton: ElevatedButton.icon(
          icon: const Icon(Icons.how_to_reg, size: 28),
          label: const Text('Apply Now', style: TextStyle(fontSize: 20)),
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFF667eea),
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 60, vertical: 20),
            shape: const StadiumBorder(),
          ),
          onPressed: () {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (_) => const ApplyRiderScreen()),
            );
          },
        ),
      );
    }

    if (status == 'pending') {
      return _buildStatusView(
        icon: Icons.hourglass_empty,
        color: Colors.orange,
        title: 'Application Under Review',
        subtitle:
            'We are reviewing your documents.\nThis usually takes 1–3 business days.',
        riderCode: _applicationData?['rider_code'],
        actionButton: ElevatedButton(
          onPressed: _loadApplicationStatus,
          style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
          child: const Text(
            'Refresh Status',
            style: TextStyle(color: Colors.white),
          ),
        ),
      );
    }

    if (status == 'approved') {
      return _buildStatusView(
        icon: Icons.check_circle,
        color: Colors.green,
        title: 'Approved!',
        subtitle: 'Welcome aboard! You are now an official Chareta Rider.',
        riderCode: _applicationData?['rider_code'],
        actionButton: ElevatedButton(
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.green,
            padding: const EdgeInsets.symmetric(horizontal: 50, vertical: 18),
          ),
          onPressed: () {
            Navigator.pushNamedAndRemoveUntil(
              context,
              '/rider-home',
              (route) => false,
            );
          },
          child: const Text(
            'Go to Rider Dashboard',
            style: TextStyle(fontSize: 18, color: Colors.white),
          ),
        ),
      );
    }

    if (status == 'rejected') {
      final reason =
          _applicationData?['rejection_reason'] ?? 'No reason provided.';
      return _buildStatusView(
        icon: Icons.cancel,
        color: Colors.red,
        title: 'Application Rejected',
        subtitle: reason,
        actionButton: ElevatedButton(
          style: ElevatedButton.styleFrom(backgroundColor: Colors.deepPurple),
          onPressed: () {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (_) => const ApplyRiderScreen()),
            );
          },
          child: const Text(
            'Re-apply Now',
            style: TextStyle(color: Colors.white),
          ),
        ),
      );
    }

    return _buildStatusView(
      icon: Icons.help_outline,
      color: Colors.grey,
      title: 'Unknown Status',
      subtitle: 'Status: $status\nPlease contact support.',
      actionButton: ElevatedButton(
        onPressed: _loadApplicationStatus,
        child: const Text('Retry'),
      ),
    );
  }

  Widget _buildDebugPanel() {
    if (!_showDebugPanel) {
      return const SizedBox.shrink();
    }

    return Container(
      margin: const EdgeInsets.all(12),
      padding: const EdgeInsets.all(12),
      constraints: const BoxConstraints(maxHeight: 400),
      decoration: BoxDecoration(
        color: Colors.black87,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.cyanAccent),
      ),
      child: Column(
        children: <Widget>[
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: <Widget>[
              const Text(
                'DEBUG LOGS',
                style: TextStyle(
                  color: Colors.cyanAccent,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Row(
                children: <Widget>[
                  IconButton(
                    icon: const Icon(Icons.clear, color: Colors.red),
                    onPressed: () {
                      if (mounted) setState(() => _debugInfo = '');
                    },
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.grey),
                    onPressed: () {
                      if (mounted) setState(() => _showDebugPanel = false);
                    },
                  ),
                ],
              ),
            ],
          ),
          const Divider(color: Colors.grey),
          Expanded(
            child: SingleChildScrollView(
              child: SelectableText(
                _debugInfo.isEmpty ? 'No logs yet...' : _debugInfo,
                style: const TextStyle(
                  color: Colors.lime,
                  fontFamily: 'monospace',
                  fontSize: 11,
                ),
              ),
            ),
          ),
          Row(
            children: <Widget>[
              ElevatedButton(
                onPressed: _loadApplicationStatus,
                child: const Text('RELOAD'),
              ),
              const SizedBox(width: 8),
              ElevatedButton(
                onPressed: () {
                  if (mounted) setState(() => _showDebugPanel = false);
                },
                child: const Text('HIDE'),
              ),
            ],
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Rider Application Status'),
        backgroundColor: const Color(0xFF667eea),
        foregroundColor: Colors.white,
        elevation: 0,
      ),
      backgroundColor: Colors.grey[50],
      body: Column(
        children: <Widget>[
          if (_showDebugPanel) _buildDebugPanel(),
          Expanded(child: _buildMainContent()),
        ],
      ),
    );
  }
}
"